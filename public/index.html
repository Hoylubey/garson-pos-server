<!-- index.html (Düzeltilmiş hali - Socket.IO bağlantısı ve olay dinleyicileri güçlendirildi, kayıt otomatik yapıldı) -->
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garson POS Sistemi - Yönetim Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

    <style>
        /* GENEL CSS STILLERI */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            padding: 1rem;
            width: 100%;
        }

        /* Navigasyon menüsü için esneklik */
        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Tüm ekranlar için içerik görünürlüğünü varsayılan olarak gizle */
        .content-section {
            display: none;
        }

        /* Mobil ekranlar için dikey düzen */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                margin-right: 0;
            }
            .main-content {
                width: 100%;
            }
        }

        /* Modal stil ve animasyonu */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Harita için özel boyut */
        #map {
            height: 600px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Yükleniyor ekranı */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        /* Mesaj kutusu */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <!-- Mesaj Kutusu -->
    <div id="messageBox" class="message-box"></div>

    <!-- Yükleniyor Ekranı -->
    <div id="loading-overlay" class="hidden">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-orange-500"></div>
        <p class="mt-4 text-xl text-orange-500">Yükleniyor...</p>
    </div>

    <!-- Ana Başlık -->
    <header class="bg-white shadow-md p-4 text-center rounded-b-xl">
        <h1 class="text-4xl font-bold text-orange-500">Olimpiyat Kokoreç</h1>
        <p id="tvLoginTitle" class="mt-2 text-xl text-gray-600"></p>
    </header>

    <!-- Navigasyon Butonları -->
    <nav id="dashboard-nav" class="nav-buttons container hidden">
        <button id="btnGarson" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg shadow-md transition-transform transform hover:scale-105">Garson Ekranı</button>
        <button id="btnYonetici" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg shadow-md transition-transform transform hover:scale-105">Yönetici Paneli</button>
        <button id="btnHarita" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg shadow-md transition-transform transform hover:scale-105">Canlı Takip</button>
        <button id="btnLogout" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg shadow-md transition-transform transform hover:scale-105">Çıkış Yap</button>
    </nav>
    
    <!-- Uygulama Bölümleri -->
    <main class="container">
        
        <!-- Giriş Ekranı -->
        <div id="login-screen" class="flex flex-col items-center justify-center h-screen hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
                <h2 class="text-3xl font-bold text-center text-orange-500 mb-6">Giriş Yap</h2>
                <input type="text" id="etUsername" placeholder="Kullanıcı Adı" class="w-full p-3 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="etPassword" placeholder="Şifre" class="w-full p-3 rounded-lg border border-gray-300 mb-6 focus:outline-none focus:ring-2 focus:ring-orange-500">
                <button id="btnLogin" class="w-full p-3 bg-orange-500 text-white rounded-lg font-semibold shadow-md transition-transform transform hover:scale-105">Giriş</button>
                <div id="login-message" class="mt-4 text-red-500 text-center"></div>
            </div>
        </div>

        <!-- Garson Ekranı -->
        <div id="garson-screen" class="content-section flex flex-col gap-4">
            <h2 class="text-3xl font-bold text-gray-700">Masalar</h2>
            <div id="tables-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <!-- Masalar buraya dinamik olarak eklenecek -->
            </div>
            <button id="btnRegisterEmployee" class="mt-4 px-6 py-3 bg-green-500 text-white rounded-lg shadow-md font-semibold transition-transform transform hover:scale-105">Yeni Çalışan Kaydet</button>
        </div>

        <!-- Yönetici Paneli -->
        <div id="yonetici-panel-screen" class="content-section flex flex-col gap-4">
            <h2 class="text-3xl font-bold text-gray-700">Yeni Siparişler</h2>
            <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Sipariş kartları buraya dinamik olarak eklenecek -->
            </div>
        </div>
        
        <!-- Canlı Harita Takip Ekranı -->
        <div id="harita-screen" class="content-section">
            <h2 class="text-3xl font-bold text-gray-700 mb-4">Canlı Motorcu Takibi</h2>
            <div id="map"></div>
            <div id="rider-status-container" class="mt-4 flex flex-wrap gap-2">
                <!-- Motorcu durumu kartları buraya dinamik olarak eklenecek -->
            </div>
        </div>

    </main>

    <!-- Modal Yapısı -->
    <div id="modal-container" class="modal hidden">
        <!-- Sipariş Atama Modalı -->
        <div id="assignOrderModal" class="modal-content">
            <h3 class="text-xl font-bold mb-4">Sipariş Atama</h3>
            <div class="mb-4">
                <p class="text-sm text-gray-500">Sipariş ID: <span id="modal-order-id" class="font-semibold text-gray-700"></span></p>
                <p class="text-sm text-gray-500">Masa Adı: <span id="modal-table-name" class="font-semibold text-gray-700"></span></p>
            </div>
            <div class="flex flex-col gap-4">
                <!-- Adres -->
                <div>
                    <label for="etDeliveryAddress" class="block text-sm font-medium text-gray-700">Teslimat Adresi:</label>
                    <textarea id="etDeliveryAddress" rows="3" placeholder="Müşteri adresi girin" class="w-full p-3 rounded-lg border border-gray-300 mt-1 focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                </div>
                <!-- Ödeme Yöntemi -->
                <div>
                    <label for="spinnerPaymentMethod" class="block text-sm font-medium text-gray-700">Ödeme Yöntemi:</label>
                    <select id="spinnerPaymentMethod" class="w-full p-3 rounded-lg border border-gray-300 mt-1 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="cash">Nakit</option>
                        <option value="credit_card">Kredi Kartı</option>
                        <option value="online">Online</option>
                    </select>
                </div>
                <!-- YENİ: İsteğe bağlı Telefon Numarası alanı eklendi -->
                <div>
                    <label for="etPhoneNumber" class="block text-sm font-medium text-gray-700">Telefon Numarası (isteğe bağlı):</label>
                    <input type="tel" id="etPhoneNumber" placeholder="Müşteri telefon numarası girin" class="w-full p-3 rounded-lg border border-gray-300 mt-1 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <!-- Motorcu Seçimi -->
                <div>
                    <label for="spinnerRider" class="block text-sm font-medium text-gray-700">Motorcu Seç:</label>
                    <select id="spinnerRider" class="w-full p-3 rounded-lg border border-gray-300 mt-1 focus:outline-none focus:ring-2 focus:ring-orange-500"></select>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button id="btnAssignConfirm" class="px-6 py-2 bg-green-500 text-white rounded-lg font-semibold shadow-md transition-transform transform hover:scale-105">Atamayı Onayla</button>
                <button id="btnAssignCancel" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold shadow-md transition-transform transform hover:scale-105">İptal</button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Kodları -->
    <script>
        const API_URL = window.location.origin;
        const socket = io(API_URL);

        // UI Elemanları
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginScreen = document.getElementById('login-screen');
        const dashboardNav = document.getElementById('dashboard-nav');
        const btnLogin = document.getElementById('btnLogin');
        const etUsername = document.getElementById('etUsername');
        const etPassword = document.getElementById('etPassword');
        const loginMessage = document.getElementById('login-message');
        const btnLogout = document.getElementById('btnLogout');
        const btnGarson = document.getElementById('btnGarson');
        const btnYonetici = document.getElementById('btnYonetici');
        const btnHarita = document.getElementById('btnHarita');
        const garsonScreen = document.getElementById('garson-screen');
        const yoneticiPanelScreen = document.getElementById('yonetici-panel-screen');
        const haritaScreen = document.getElementById('harita-screen');
        const ordersContainer = document.getElementById('orders-container');
        const spinnerRider = document.getElementById('spinnerRider');
        const assignOrderModal = document.getElementById('assignOrderModal');
        const modalContainer = document.getElementById('modal-container');
        const btnAssignConfirm = document.getElementById('btnAssignConfirm');
        const btnAssignCancel = document.getElementById('btnAssignCancel');
        const etDeliveryAddress = document.getElementById('etDeliveryAddress');
        const spinnerPaymentMethod = document.getElementById('spinnerPaymentMethod');
        
        // YENİ: Telefon numarası input elementini seçiyoruz
        const etPhoneNumber = document.getElementById('etPhoneNumber');

        let map;
        let riderMarkers = {};
        let currentUserRole;
        let currentUsername;
        let activeModalOrderId = null;
        let riderAvailability = {};
        
        // YENİ: Siparişler için marker'ları tutacak nesne
        let orderMarkers = {};
        
        // YENİ: Paket ikonu için SVG içeriği
        const packageIconSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#3B82F6" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                <path d="M12 2l-8 4v8l8 4 8-4v-8l-8-4z" />
                <path d="M12 2v8M4 6l8 4M20 6l-8 4M12 10v8" />
            </svg>
        `;

        // YENİ: Özel Paket İkonu oluşturma (L.divIcon kullanarak)
        const packageIcon = L.divIcon({
            className: 'custom-package-icon',
            html: `<div style="background-color:#3B82F6; padding: 4px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"><div style="color:white; font-weight:bold; width: 24px; height: 24px;">${packageIconSvg}</div></div>`,
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
        });

        // YENİ: Mock Geocoding Fonksiyonu (Adresten koordinat döndürmek için)
        async function geocodeAddress(address) {
            console.log(`Mock Geocoding: Adres için koordinat aranıyor: "${address}"`);
            const mockLat = 39.925533 + (Math.random() - 0.5) * 0.05;
            const mockLng = 32.866287 + (Math.random() - 0.5) * 0.05;
            return { lat: mockLat, lng: mockLng };
        }

        // --- AUTH & KULLANICI ARAYÜZÜ YÖNETİMİ ---

        function showMessage(text, duration = 3000) {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = text;
            msgBox.classList.add('show');
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, duration);
        }

        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        function getUserRole() {
            return localStorage.getItem('userRole');
        }

        function getLoggedInUsername() {
            return localStorage.getItem('username');
        }

        function showDashboard() {
            loginScreen.classList.add('hidden');
            dashboardNav.classList.remove('hidden');
            document.getElementById('tvLoginTitle').textContent = `Hoş Geldin, ${currentUsername}! (${currentUserRole === 'admin' ? 'Yönetici' : currentUserRole === 'garson' ? 'Garson' : 'Motorcu'})`;
            switch (currentUserRole) {
                case 'admin':
                    showYoneticiPanel();
                    break;
                case 'garson':
                    showGarsonScreen();
                    break;
                case 'rider':
                    showMapScreen();
                    break;
                default:
                    showLoginScreen();
            }
        }

        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            dashboardNav.classList.add('hidden');
            garsonScreen.classList.add('hidden');
            yoneticiPanelScreen.classList.add('hidden');
            haritaScreen.classList.add('hidden');
            localStorage.clear();
        }

        function switchScreen(screenId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            if (screenId === 'harita-screen') {
                initMap();
            }
        }
        
        function showGarsonScreen() {
            switchScreen('garson-screen');
        }
        
        function showYoneticiPanel() {
            switchScreen('yonetici-panel-screen');
        }

        function showMapScreen() {
            switchScreen('harita-screen');
        }

        // --- MODAL YÖNETİMİ ---
        function showModal(modalId) {
            modalContainer.classList.remove('hidden');
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            modalContainer.classList.add('hidden');
            document.getElementById(modalId).classList.add('hidden');
        }

        // Sipariş Atama Modalını Açma
        async function openAssignOrderModal(orderId, masaAdi) {
            showModal('assignOrderModal');
            document.getElementById('modal-order-id').textContent = orderId;
            document.getElementById('modal-table-name').textContent = masaAdi;
            activeModalOrderId = orderId;
            etDeliveryAddress.value = '';
            etPhoneNumber.value = ''; // YENİ: Telefon numarası inputunu temizle

            // Motorcuları yükle
            spinnerRider.innerHTML = '';
            const availableRiders = Object.keys(riderAvailability);
            if (availableRiders.length > 0) {
                availableRiders.forEach(rider => {
                    const option = document.createElement('option');
                    option.value = rider;
                    option.textContent = rider;
                    spinnerRider.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.textContent = 'Motorcu Yok';
                spinnerRider.appendChild(option);
                btnAssignConfirm.disabled = true;
            }
        }

        // Sipariş Atama Modalını Kapatma
        function closeAssignOrderModal() {
            hideModal('assignOrderModal');
            activeModalOrderId = null;
            btnAssignConfirm.disabled = false;
        }

        // --- HARİTA YÖNETİMİ ---

        function initMap() {
            if (map) {
                map.remove();
            }
            map = L.map('map').setView([39.925533, 32.866287], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Harita boyutunun doğru ayarlandığından emin ol
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }

        function updateRiderMarker(username, lat, lng) {
            const latLng = [lat, lng];
            if (riderMarkers[username]) {
                riderMarkers[username].setLatLng(latLng);
            } else {
                const marker = L.marker(latLng).addTo(map)
                    .bindPopup(`<b>${username}</b><br>Konum: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                riderMarkers[username] = marker;
            }
        }

        function removeRiderMarker(username) {
            if (riderMarkers[username]) {
                map.removeLayer(riderMarkers[username]);
                delete riderMarkers[username];
            }
        }

        // --- YENİ: SİPARİŞ MARKER YÖNETİMİ ---

        async function addOrderMarker(order) {
            // Eğer sipariş zaten haritada varsa, tekrar ekleme
            if (orderMarkers[order.orderId]) {
                console.log(`Sipariş ${order.orderId} zaten haritada.`);
                return;
            }

            // Adresten koordinatları al (mock)
            try {
                const coords = await geocodeAddress(order.deliveryAddress);
                const latLng = [coords.lat, coords.lng];
                
                // Marker oluştur
                const marker = L.marker(latLng, { icon: packageIcon }).addTo(map)
                    .bindPopup(`
                        <div class="p-2">
                            <b>Sipariş: ${order.orderId.substring(0, 8)}...</b><br>
                            Masa: ${order.masaAdi}<br>
                            Motorcu: ${order.riderUsername || 'Yok'}<br>
                            Adres: ${order.deliveryAddress}<br>
                            Durum: <span class="text-blue-500">${order.deliveryStatus || 'Atandı'}</span>
                        </div>
                    `);
                
                // Marker'ı siparişler nesnesine ekle
                orderMarkers[order.orderId] = marker;
                console.log(`Sipariş ${order.orderId} için haritaya marker eklendi.`);
            } catch (error) {
                console.error(`Sipariş ${order.orderId} için geocoding hatası:`, error);
            }
        }

        function removeOrderMarker(orderId) {
            if (orderMarkers[orderId]) {
                map.removeLayer(orderMarkers[orderId]);
                delete orderMarkers[orderId];
                console.log(`Sipariş ${orderId} marker'ı haritadan kaldırıldı.`);
            }
        }
        
        // --- DİNAMİK İÇERİK OLUŞTURMA ---
        
        function renderOrders() {
            if (!ordersContainer) return;
            ordersContainer.innerHTML = '';
            Object.values(orders).forEach(order => {
                // Sadece yönetici panelinde gösterilecek siparişler
                if (order.status !== 'paid') {
                    const orderCard = createOrderCard(order);
                    ordersContainer.appendChild(orderCard);
                }
                
                // YENİ: Atanmış ve teslim edilmemiş siparişler için marker ekle
                if (currentUserRole === 'admin' && order.status === 'assigned' && order.deliveryStatus !== 'delivered') {
                    addOrderMarker(order);
                }
            });
        }
        
        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-xl shadow-md';
            card.innerHTML = `
                <p class="text-sm text-gray-500">Sipariş ID: <span class="font-semibold text-gray-700">${order.orderId.substring(0, 8)}...</span></p>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Masa: ${order.masaAdi}</h3>
                <p class="text-gray-600 mb-2">Toplam Fiyat: <span class="font-bold">${order.toplamFiyat.toFixed(2)} TL</span></p>
                <div class="mt-4 flex gap-2">
                    <button class="btn-mark-paid px-4 py-2 bg-green-500 text-white rounded-lg transition-transform transform hover:scale-105" data-order-id="${order.orderId}">Ödendi</button>
                    <button class="btn-assign-rider px-4 py-2 bg-orange-500 text-white rounded-lg transition-transform transform hover:scale-105" data-order-id="${order.orderId}" data-masa-adi="${order.masaAdi}">Motorcuya Gönder</button>
                </div>
            `;
            
            card.querySelector('.btn-mark-paid').addEventListener('click', () => {
                socket.emit('markOrderAsPaid', { orderId: order.orderId });
            });
            
            card.querySelector('.btn-assign-rider').addEventListener('click', (e) => {
                const id = e.target.dataset.orderId;
                const masaAdi = e.target.dataset.masaAdi;
                openAssignOrderModal(id, masaAdi);
            });

            return card;
        }


        // --- EKRAN GEÇİŞİ İŞLEMLERİ ---

        btnGarson.addEventListener('click', () => showGarsonScreen());
        btnYonetici.addEventListener('click', () => showYoneticiPanel());
        btnHarita.addEventListener('click', () => showMapScreen());
        btnLogout.addEventListener('click', () => {
            showLoginScreen();
            showMessage('Başarıyla çıkış yapıldı.');
        });

        // --- GİRİŞ İŞLEMLERİ ---
        btnLogin.addEventListener('click', async () => {
            const username = etUsername.value;
            const password = etPassword.value;
            if (!username || !password) {
                showMessage('Kullanıcı adı ve şifre boş bırakılamaz.', 5000);
                return;
            }
            loadingOverlay.classList.remove('hidden');
            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userRole', data.role);
                    localStorage.setItem('username', data.username);
                    currentUserRole = data.role;
                    currentUsername = data.username;
                    showDashboard();
                } else {
                    showMessage(data.message, 5000);
                }
            } catch (error) {
                console.error('Giriş hatası:', error);
                showMessage('Sunucuya bağlanılamadı. Lütfen tekrar deneyin.', 5000);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        // --- SİPARİŞ ATAMA İŞLEMLERİ ---
        btnAssignConfirm.addEventListener('click', () => {
            const orderId = activeModalOrderId;
            const riderUsername = spinnerRider.value;
            const deliveryAddress = etDeliveryAddress.value;
            const paymentMethod = spinnerPaymentMethod.value;
            const phoneNumber = etPhoneNumber.value; // YENİ: Telefon numarasını al

            if (!riderUsername || !deliveryAddress) {
                showMessage('Lütfen tüm zorunlu alanları doldurun.', 5000);
                return;
            }

            // YENİ: Telefon numarasını da sunucuya gönderiyoruz
            socket.emit('assignOrder', { orderId, riderUsername, deliveryAddress, paymentMethod, phoneNumber });
            closeAssignOrderModal();
        });

        btnAssignCancel.addEventListener('click', closeAssignOrderModal);

        // --- SOCKET.IO OLAYLARI ---
        let orders = {};

        socket.on('connect', () => {
            console.log("Sunucuya bağlandı.");
            const token = getAuthToken();
            if (token) {
                const role = getUserRole();
                const username = getLoggedInUsername();
                socket.emit('join', { username, role });
            }
        });

        socket.on('initialData', (data) => {
            orders = data.orders.reduce((acc, order) => {
                acc[order.orderId] = order;
                return acc;
            }, {});
            riderAvailability = data.riders;
            console.log('Başlangıç verileri alındı:', orders);
            renderOrders();
        });

        socket.on('riderConnected', (username) => {
            console.log(`Yeni motorcu bağlandı: ${username}`);
            riderAvailability[username] = true;
        });

        socket.on('riderDisconnected', (username) => {
            console.log(`Motorcu ayrıldı: ${username}`);
            delete riderAvailability[username];
            removeRiderMarker(username);
        });

        socket.on('newOrderReceived', (order) => {
            console.log('Yeni sipariş alındı:', order);
            orders[order.orderId] = order;
            renderOrders();
            showMessage(`Yeni sipariş geldi: Masa ${order.masaAdi}`);
        });

        socket.on('orderAssigned', (order) => {
            console.log('Sipariş atandı:', order);
            orders[order.orderId] = order;
            renderOrders();
            showMessage(`Sipariş, motorcu ${order.riderUsername} kişisine atandı.`);
        });

        socket.on('orderDeliveryStatusUpdated', (data) => {
            console.log('Sipariş teslimat durumu güncellendi:', data.orderId, 'Yeni Durum:', data.newDeliveryStatus);
            if (orders[data.orderId]) {
                orders[data.orderId].deliveryStatus = data.newDeliveryStatus;
                renderOrders();
            }
            // YENİ: Eğer durum 'delivered' ise marker'ı kaldır
            if (data.newDeliveryStatus === 'delivered') {
                removeOrderMarker(data.orderId);
                showMessage(`Sipariş ${data.orderId.substring(0, 8)}... teslim edildi.`);
            }
        });

        socket.on('orderPaidConfirmation', (data) => {
            console.log('Sipariş ödendi olarak işaretlendi:', data.orderId);
            delete orders[data.orderId];
            renderOrders();
            showMessage(`Sipariş ${data.orderId.substring(0, 8)}... ödendi olarak işaretlendi.`);
        });

        socket.on('riderLocationUpdate', (data) => {
            updateRiderMarker(data.username, data.latitude, data.longitude);
        });

        // Pencere yeniden boyutlandırıldığında haritayı yeniden boyutlandır
        window.addEventListener('resize', () => {
            if (map) {
                map.invalidateSize();
            }
        });
        
        // --- SAYFA YÜKLEME VE BAŞLANGIÇ KONTROLÜ ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded: Sayfa yüklendi.");
            const token = getAuthToken();
            if (token) {
                console.log("DOMContentLoaded: Token bulundu, dashboard gösteriliyor.");
                currentUserRole = getUserRole();
                currentUsername = getLoggedInUsername();
                showDashboard();
            } else {
                console.log("DOMContentLoaded: Token bulunamadı, login ekranı gösteriliyor.");
                showLoginScreen();
            }
        });
    </script>
</body>
</html>

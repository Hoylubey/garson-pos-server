<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli - Mutfak / Kasa / POS</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4Nx5LZrLtx9zG+gK1Ntx9q2L9M2+D2D+p0Bq3C2A3A="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-p4Nx5LZrLtx9zG+gK1Ntx9q2L9M2+D2D+p0Bq3C2A3A="
        crossorigin=""></script>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

    <style>
        /* Genel Stil Ayarları */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            margin: 0;
            font-size: 1.8em;
            flex-grow: 1;
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
        }
        .tab-button {
            background-color: #34495e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        .tab-button:hover {
            background-color: #4a627a;
        }
        .tab-button.active {
            background-color: #1abc9c;
            font-weight: bold;
        }

        main {
            display: flex;
            flex: 1; /* Ana içeriğin dikeyde kalan alanı kaplamasını sağlar */
            padding: 20px;
            gap: 20px;
            overflow: auto; /* İçerik taşarsa kaydırma çubuğu çıkar */
        }

        .content-section {
            display: none; /* Varsayılan olarak tüm bölümleri gizle */
            flex-direction: column;
            flex: 1;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            padding: 20px;
        }
        .content-section.active {
            display: flex; /* Aktif bölümü göster */
        }

        /* Mutfak / Kasa Ekranı CSS stilleri */
        #main-content {
            flex: 2; /* Daha fazla yer kaplasın */
        }
        #map-container {
            flex: 1; /* Kalan yeri kaplasın */
            padding: 15px;
            height: 80vh; /* Yüksekliği ayarla */
            position: sticky;
            top: 20px;
            align-self: flex-start; /* Üstte hizala */
        }
        #map {
            width: 100%;
            height: calc(100% - 30px);
            border-radius: 4px;
            margin-top: 10px;
        }
        #orders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .order-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            border-left: 5px solid #4CAF50;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .order-card .order-header {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #2196F3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .order-card .order-header span {
            font-size: 0.8em;
            color: #666;
            background-color: #e0e0e0;
            padding: 3px 8px;
            border-radius: 5px;
        }
        .order-card .order-item {
            margin-left: 10px;
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        .order-card .order-total {
            font-weight: bold;
            margin-top: 10px;
            text-align: right;
            font-size: 1.2em;
            color: #333;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }
        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .pay-button, .print-button {
            flex: 1;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            box-sizing: border-box;
            transition: background-color 0.2s ease;
        }
        .pay-button { background-color: #28a745; }
        .pay-button:hover { background-color: #218838; }
        .print-button { background-color: #007bff; }
        .print-button:hover { background-color: #0056b3; }

        /* Bildirim zili stilleri */
        .notification-bell {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #FFC107;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: none;
            z-index: 1000;
        }
        @keyframes ring {
            0% { transform: rotate(0deg); }
            10% { transform: rotate(15deg); }
            20% { transform: rotate(-15deg); }
            30% { transform: rotate(15deg); }
            40% { transform: rotate(-15deg); }
            50% { transform: rotate(0deg); }
            100% { transform: rotate(0deg); }
        }
        .ringing {
            animation: ring 0.5s ease-in-out 3;
        }

        /* Yazdırma işlemi için gerekli stil - Sadece çıktıda görünür */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .order-actions, .tab-buttons, header {
                display: none;
            }

            /* POS Fişi Stilleri */
            @page {
                size: 58mm auto;
                margin: 0;
            }
            body {
                width: 58mm;
                margin: 0;
                font-family: 'Consolas', 'Courier New', monospace;
                font-size: 10px;
                line-height: 1.2;
                color: #000;
            }
            .receipt-container {
                padding: 5mm;
                box-sizing: border-box;
            }
            .receipt-header, .receipt-footer {
                text-align: center;
                margin-bottom: 5px;
            }
            .receipt-info p, .receipt-item {
                margin: 2px 0;
                white-space: pre-wrap;
            }
            .receipt-total {
                font-weight: bold;
                text-align: right;
                margin-top: 10px;
                font-size: 11px;
            }
            hr {
                border: 0;
                border-top: 1px dashed #888;
                margin: 5px 0;
            }
        }

        /* POS Ekranı CSS stilleri */
        #pos-screen {
            display: flex; /* POS ekranının içindeki düzen */
            flex-grow: 1; /* Kalan tüm alanı kaplasın */
            gap: 20px;
            min-height: 70vh; /* Minimum yükseklik */
        }
        .product-categories, .product-list, .cart-section {
            background-color: #f8f8f8;
            border-radius: 8px;
            padding: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .product-categories {
            flex: 0 0 200px; /* Sabit genişlik */
            max-height: 100%;
            overflow-y: auto;
            border-right: 1px solid #eee;
        }
        .category-button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            background-color: #ecf0f1;
            border: none;
            border-radius: 5px;
            text-align: left;
            font-size: 1.05em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .category-button:hover {
            background-color: #dbe2e6;
            transform: translateY(-1px);
        }
        .category-button.active {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }

        .product-list {
            flex: 2; /* Ürün listesi daha geniş olsun */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            overflow-y: auto;
        }
        .product-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .product-card img {
            max-width: 80%;
            height: auto;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .product-card h4 {
            margin: 5px 0;
            font-size: 1.1em;
            color: #2c3e50;
        }
        .product-card p {
            font-size: 1.2em;
            font-weight: bold;
            color: #27ae60;
            margin-top: auto; /* En alta hizala */
        }

        .cart-section {
            flex: 1; /* Sepet ve ödeme bölümü */
            max-width: 350px; /* Sabit genişlik */
            border-left: 1px solid #eee;
            position: relative; /* Sabit durması için */
        }
        .cart-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        #cart-items {
            flex: 1; /* Sepet içeriğinin kaydırılabilir olmasını sağlar */
            overflow-y: auto;
            margin-bottom: 15px;
            max-height: calc(100% - 200px); /* Kalan alanı kapla */
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-info {
            flex-grow: 1;
        }
        .cart-item-info span {
            font-weight: bold;
            color: #34495e;
        }
        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .quantity-button {
            background-color: #3498db;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        .quantity-button:hover {
            background-color: #2980b9;
        }
        .remove-item {
            background-color: #e74c3c;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
            transition: background-color 0.2s ease;
        }
        .remove-item:hover {
            background-color: #c0392b;
        }
        
        #cart-summary {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid #eee;
            font-size: 1.3em;
            font-weight: bold;
            text-align: right;
            color: #2c3e50;
        }
        .payment-options {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .payment-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .payment-button.cash { background-color: #2ecc71; }
        .payment-button.cash:hover { background-color: #27ad60; }
        .payment-button.credit { background-color: #9b59b6; }
        .payment-button.credit:hover { background-color: #8e44ad; }
        .payment-button.send-order { background-color: #f39c12; } /* Sipariş gönder butonu için renk */
        .payment-button.send-order:hover { background-color: #e67e22; }

        .table-selection {
            margin-bottom: 15px;
        }
        .table-selection select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <header>
        <h1>Yönetim Paneli</h1>
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="kitchen-cashier">Mutfak/Kasa Ekranı</button>
            <button class="tab-button" data-tab="pos-system">POS Sistemi</button>
        </div>
    </header>

    <main>
        <section id="kitchen-cashier" class="content-section active">
            <div id="main-content">
                <h2>Bekleyen Siparişler</h2>
                <div id="orders-container">
                    </div>
            </div>

            <div id="map-container">
                <h2>Motorcu Konumları</h2>
                <div id="map"></div>
            </div>
        </section>

        <section id="pos-system" class="content-section">
            <div id="pos-screen">
                <div class="product-categories">
                    <h3>Kategoriler</h3>
                    <div id="category-buttons">
                        </div>
                </div>

                <div class="product-list">
                    <h3>Ürünler</h3>
                    <div id="product-cards">
                        </div>
                </div>

                <div class="cart-section">
                    <h3>Sepet</h3>
                    <div class="table-selection">
                        <label for="tableName">Masa Seç/Adı Gir:</label>
                        <select id="tableName">
                            <option value="Masa 1">Masa 1</option>
                            <option value="Masa 2">Masa 2</option>
                            <option value="Masa 3">Masa 3</option>
                            <option value="Paket Servis">Paket Servis</option>
                            <option value="Diğer">Diğer (Manuel Giriş)</option>
                        </select>
                        <input type="text" id="customTableName" placeholder="Masa Adı / Sipariş Notu" style="display: none; margin-top: 5px; padding: 8px; width: calc(100% - 16px); border-radius: 5px; border: 1px solid #ccc;">
                    </div>
                    <div id="cart-items">
                        <p id="empty-cart-message">Sepet boş.</p>
                    </div>
                    <div id="cart-summary">
                        Toplam: <span id="cart-total">0.00</span> TL
                    </div>
                    <div class="payment-options">
                        <button class="payment-button send-order" id="send-order-button">Sipariş Gönder (Mutfak)</button>
                        <button class="payment-button cash" id="pay-cash-button">Nakit Ödeme</button>
                        <button class="payment-button credit" id="pay-credit-button">Kredi Kartı Ödeme</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="notificationBell" class="notification-bell">🔔</div>
    <audio id="notificationSound" src="notification.mp3" preload="auto"></audio>

    <script>
        // Socket.IO istemcisini başlat
        // BURAYI KENDİ SUNUCU ADRESİNİZLE DEĞİŞTİRMELİSİNİZ!
        const socket = io('https://garson-pos-server.onrender.com');

        // =========================================================
        // Ortak DOM Elemanları ve Yardımcı Fonksiyonlar
        // =========================================================
        const notificationSound = document.getElementById('notificationSound');
        const notificationBell = document.getElementById('notificationBell');

        function playNotificationSound(type = 'newOrder') {
            const audio = document.getElementById('notificationSound');
            if (audio) {
                audio.play().catch(e => console.error("Ses çalma hatası:", e));
            }
        }

        // =========================================================
        // Tab Navigasyon Mantığı
        // =========================================================
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        // =========================================================
        // Mutfak / Kasa Ekranı Mantığı
        // =========================================================
        const ordersContainer = document.getElementById('orders-container');
        let map;
        const riderMarkers = {};

        function initMap() {
            const initialLat = 41.0082; // İstanbul
            const initialLng = 28.9784;

            map = L.map('map').setView([initialLat, initialLng], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            socket.emit('requestCurrentRiderLocations');
        }

        function addOrderToDisplay(order) {
            const orderCard = document.createElement('div');
            orderCard.className = 'order-card';
            orderCard.id = `order-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            orderCard.dataset.orderId = orderCard.id;

            orderCard.innerHTML = `
                <div class="order-header">
                    Masa: ${order.tableName || order.orderId}
                    <span>${order.platform || 'Bilinmiyor'}</span>
                </div>
                <div class="order-details">
                    ${order.items.map(item => `
                        <div class="order-item">
                            ${item.productName} (${item.quantity} adet) - ${item.totalPrice.toFixed(2)} TL
                        </div>
                    `).join('')}
                </div>
                <div class="order-total">Toplam: ${order.totalAmount.toFixed(2)} TL</div>
                <div class="order-actions">
                    <button class="pay-button">Ödendi</button>
                    <button class="print-button">Yazdır</button>
                </div>
            `;

            const payButton = orderCard.querySelector('.pay-button');
            payButton.addEventListener('click', () => {
                console.log('Sipariş ödendi:', order);
                socket.emit('orderPaid', {
                    orderId: orderCard.dataset.orderId,
                    tableName: order.tableName || order.orderId, // Ödeme bildirimi için orderId veya tableName kullan
                    totalAmount: order.totalAmount
                });
                orderCard.remove();
                playNotificationSound('payment'); // İsteğe bağlı olarak ödeme sesi çalabilir
            });

            const printButton = orderCard.querySelector('.print-button');
            printButton.addEventListener('click', () => {
                console.log('Fiş yazdırma isteği:', order);
                printOrderReceipt(order);
            });

            ordersContainer.prepend(orderCard);
        }

        function printOrderReceipt(order) {
            let printContent = `
                <div class="receipt-container">
                    <div class="receipt-header">--- Olimpiyat Kokoreç ---</div>
                    <p class="receipt-info">Masa/Sipariş No: ${order.tableName || order.orderId}</p>
                    <p class="receipt-info">Tarih: ${new Date().toLocaleString()}</p>
                    <hr>
                    <div class="receipt-items">
            `;
            order.items.forEach(item => {
                printContent += `<p class="receipt-item">${item.productName} (${item.quantity} adet) - ${item.totalPrice.toFixed(2)} TL</p>`;
            });
            printContent += `
                    </div>
                    <hr>
                    <div class="receipt-total">TOPLAM: ${order.totalAmount.toFixed(2)} TL</div>
                    <div class="receipt-footer">Afiyet Olsun! Teşekkürler!</div>
                </div>
            `;
            let printWindow = window.open('', '_blank');
            printWindow.document.write('<!DOCTYPE html><html><head><title>Fiş - ' + (order.tableName || order.orderId) + '</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                @page { size: 58mm auto; margin: 0; }
                body { width: 58mm; margin: 0; font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; line-height: 1.2; color: #000; }
                .receipt-container { padding: 5mm; box-sizing: border-box; }
                .receipt-header, .receipt-footer { text-align: center; margin-bottom: 5px; }
                .receipt-info p, .receipt-item { margin: 2px 0; white-space: pre-wrap; }
                .receipt-total { font-weight: bold; text-align: right; margin-top: 10px; font-size: 11px; }
                hr { border: 0; border-top: 1px dashed #888; margin: 5px 0; }
            `);
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function updateRiderLocation(locationData) {
            const { riderId, latitude, longitude, speed, bearing, timestamp } = locationData;
            const latLng = [latitude, longitude];

            if (!map) {
                console.warn('Harita henüz başlatılmadı.');
                return;
            }

            const customIcon = L.icon({
                iconUrl: 'images/motorcu_icon.png',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16]
            });

            if (riderMarkers[riderId]) {
                riderMarkers[riderId].setLatLng(latLng);
                if (riderMarkers[riderId].getPopup()) {
                    riderMarkers[riderId].getPopup().setContent(
                        `<div><strong>Motorcu ID:</strong> ${riderId}</div>` +
                        `<div><strong>Konum:</strong> ${latitude.toFixed(4)}, ${longitude.toFixed(4)}</div>` +
                        `<div><strong>Hız:</strong> ${speed ? (speed * 3.6).toFixed(2) + ' km/s' : 'Bilinmiyor'}</div>` +
                        `<div><strong>Yön:</strong> ${bearing !== undefined ? bearing.toFixed(0) + '°' : 'Bilinmiyor'}</div>` +
                        `<div><strong>Güncellenme:</strong> ${new Date(timestamp).toLocaleTimeString()}</div>`
                    );
                }
            } else {
                riderMarkers[riderId] = L.marker(latLng, { icon: customIcon }).addTo(map)
                    .bindPopup(
                        `<div><strong>Motorcu ID:</strong> ${riderId}</div>` +
                        `<div><strong>Konum:</strong> ${latitude.toFixed(4)}, ${longitude.toFixed(4)}</div>` +
                        `<div><strong>Hız:</strong> ${speed ? (speed * 3.6).toFixed(2) + ' km/s' : 'Bilinmiyor'}</div>` +
                        `<div><strong>Yön:</strong> ${bearing !== undefined ? bearing.toFixed(0) + '°' : 'Bilinmiyor'}</div>` +
                        `<div><strong>Güncellenme:</strong> ${new Date(timestamp).toLocaleTimeString()}</div>`
                    );
            }
        }

        // =========================================================
        // POS Sistemi Mantığı
        // =========================================================

        const products = {
            "İçecekler": [
                { id: "coke", name: "Kola", price: 25.00, image: "images/coke.png" },
                { id: "fanta", name: "Fanta", price: 22.00, image: "images/fanta.png" },
                { id: "ayran", name: "Ayran", price: 15.00, image: "images/ayran.png" },
                { id: "su", name: "Su", price: 10.00, image: "images/water.png" }
            ],
            "Kokoreç": [
                { id: "yarim_ekmek_kokorec", name: "Yarım Ekmek Kokoreç", price: 120.00, image: "images/kokorec_yarim.png" },
                { id: "tam_ekmek_kokorec", name: "Tam Ekmek Kokoreç", price: 200.00, image: "images/kokorec_tam.png" },
                { id: "porsiyon_kokorec", name: "Porsiyon Kokoreç", price: 150.00, image: "images/kokorec_porsiyon.png" }
            ],
            "Yan Ürünler": [
                { id: "patates_cips", name: "Patates Cips", price: 40.00, image: "images/fries.png" },
                { id: "turşu", name: "Turşu", price: 10.00, image: "images/pickle.png" }
            ],
            "Tatlılar": [
                { id: "sutlac", name: "Sütlaç", price: 35.00, image: "images/sutlac.png" },
                { id: "kunefe", name: "Künefe", price: 60.00, image: "images/kunefe.png" }
            ]
        };

        let cart = [];
        let currentTableName = "Masa 1"; // Varsayılan masa adı

        const categoryButtonsDiv = document.getElementById('category-buttons');
        const productCardsDiv = document.getElementById('product-cards');
        const cartItemsDiv = document.getElementById('cart-items');
        const cartTotalSpan = document.getElementById('cart-total');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const tableNameSelect = document.getElementById('tableName');
        const customTableNameInput = document.getElementById('customTableName');
        const sendOrderButton = document.getElementById('send-order-button');
        const payCashButton = document.getElementById('pay-cash-button');
        const payCreditButton = document.getElementById('pay-credit-button');

        // Kategori butonlarını oluştur
        function renderCategories() {
            categoryButtonsDiv.innerHTML = '';
            Object.keys(products).forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-button';
                button.textContent = category;
                button.dataset.category = category;
                button.addEventListener('click', () => {
                    document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderProducts(category);
                });
                categoryButtonsDiv.appendChild(button);
            });
            // İlk kategoriyi varsayılan olarak seç
            if (Object.keys(products).length > 0) {
                categoryButtonsDiv.querySelector('.category-button').click();
            }
        }

        // Ürün kartlarını oluştur
        function renderProducts(category) {
            productCardsDiv.innerHTML = '';
            products[category].forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}">
                    <h4>${product.name}</h4>
                    <p>${product.price.toFixed(2)} TL</p>
                `;
                productCard.addEventListener('click', () => addProductToCart(product));
                productCardsDiv.appendChild(productCard);
            });
        }

        // Ürünü sepete ekle
        function addProductToCart(product) {
            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity++;
                existingItem.totalPrice = existingItem.quantity * existingItem.price;
            } else {
                cart.push({ ...product, quantity: 1, totalPrice: product.price });
            }
            updateCartDisplay();
        }

        // Sepeti güncelle ve ekranda göster
        function updateCartDisplay() {
            cartItemsDiv.innerHTML = '';
            if (cart.length === 0) {
                emptyCartMessage.style.display = 'block';
            } else {
                emptyCartMessage.style.display = 'none';
                cart.forEach(item => {
                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'cart-item';
                    cartItemDiv.innerHTML = `
                        <div class="cart-item-info">
                            ${item.name} <span>(x${item.quantity})</span>
                        </div>
                        <div class="cart-item-actions">
                            <button class="quantity-button" data-action="decrease" data-id="${item.id}">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-button" data-action="increase" data-id="${item.id}">+</button>
                            <button class="remove-item" data-id="${item.id}">X</button>
                        </div>
                    `;
                    cartItemsDiv.appendChild(cartItemDiv);
                });
            }
            updateCartTotal();
            addCartItemEventListeners();
        }

        // Sepet toplamını hesapla ve güncelle
        function updateCartTotal() {
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            cartTotalSpan.textContent = total.toFixed(2);
        }

        // Sepet öğelerinin butonlarına event listener ekle
        function addCartItemEventListeners() {
            document.querySelectorAll('.quantity-button').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.id;
                    const action = e.target.dataset.action;
                    const item = cart.find(i => i.id === id);
                    if (item) {
                        if (action === 'increase') {
                            item.quantity++;
                        } else if (action === 'decrease') {
                            item.quantity--;
                        }
                        if (item.quantity <= 0) {
                            cart = cart.filter(i => i.id !== id);
                        } else {
                            item.totalPrice = item.quantity * item.price;
                        }
                        updateCartDisplay();
                    }
                };
            });
            document.querySelectorAll('.remove-item').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.id;
                    cart = cart.filter(item => item.id !== id);
                    updateCartDisplay();
                };
            });
        }

        // Masa seçimi veya manuel giriş değiştiğinde
        tableNameSelect.addEventListener('change', (event) => {
            if (event.target.value === 'Diğer') {
                customTableNameInput.style.display = 'block';
                customTableNameInput.focus();
                currentTableName = ''; // Custom input'a bırak
            } else {
                customTableNameInput.style.display = 'none';
                currentTableName = event.target.value;
            }
        });

        customTableNameInput.addEventListener('input', (event) => {
            currentTableName = event.target.value;
        });

        // Sipariş Gönder butonu
        sendOrderButton.addEventListener('click', async () => {
            if (cart.length === 0) {
                alert('Sepet boş! Lütfen ürün ekleyin.');
                return;
            }
            if (!currentTableName && tableNameSelect.value === 'Diğer') {
                alert('Lütfen masa adı veya sipariş notu girin.');
                return;
            }

            const orderData = {
                tableName: (tableNameSelect.value === 'Diğer' ? currentTableName : tableNameSelect.value),
                items: cart,
                totalAmount: parseFloat(cartTotalSpan.textContent),
                platform: 'POS' // Siparişin POS'tan geldiğini belirt
            };

            console.log('POS Siparişi Gönderiliyor:', orderData);

            try {
                // HTTP POST isteği ile siparişi sunucuya gönder
                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Sipariş başarıyla gönderildi!');
                    console.log(result.message);
                    cart = []; // Sepeti temizle
                    updateCartDisplay();
                    // Masa seçimini varsayılana döndür
                    tableNameSelect.value = 'Masa 1';
                    customTableNameInput.style.display = 'none';
                    currentTableName = 'Masa 1';
                } else {
                    alert('Sipariş gönderilirken bir hata oluştu.');
                    console.error('Sipariş gönderme hatası:', response.statusText);
                }
            } catch (error) {
                alert('Sunucuya bağlanırken bir hata oluştu.');
                console.error('Fetch hatası:', error);
            }
        });

        // Ödeme Butonları (Örneklik İçin - Gerçek entegrasyon burada başlar)
        payCashButton.addEventListener('click', () => {
            if (cart.length === 0) {
                alert('Sepet boş! Ödeme yapılamaz.');
                return;
            }
            if (!currentTableName && tableNameSelect.value === 'Diğer') {
                alert('Lütfen masa adı veya sipariş notu girin.');
                return;
            }

            const orderData = {
                tableName: (tableNameSelect.value === 'Diğer' ? currentTableName : tableNameSelect.value),
                items: cart,
                totalAmount: parseFloat(cartTotalSpan.textContent),
                paymentMethod: 'Nakit',
                platform: 'POS'
            };

            console.log('Nakit Ödeme Yapıldı:', orderData);
            alert(`Nakit ödeme alındı: ${orderData.totalAmount.toFixed(2)} TL`);

            // Fişi yazdır
            printOrderReceipt(orderData);

            // Sepeti temizle ve sıfırla
            cart = [];
            updateCartDisplay();
            tableNameSelect.value = 'Masa 1';
            customTableNameInput.style.display = 'none';
            currentTableName = 'Masa 1';
        });

        payCreditButton.addEventListener('click', () => {
            if (cart.length === 0) {
                alert('Sepet boş! Ödeme yapılamaz.');
                return;
            }
            if (!currentTableName && tableNameSelect.value === 'Diğer') {
                alert('Lütfen masa adı veya sipariş notu girin.');
                return;
            }

            const orderData = {
                tableName: (tableNameSelect.value === 'Diğer' ? currentTableName : tableNameSelect.value),
                items: cart,
                totalAmount: parseFloat(cartTotalSpan.textContent),
                paymentMethod: 'Kredi Kartı',
                platform: 'POS'
            };

            console.log('Kredi Kartı Ödeme Yapıldı:', orderData);
            alert(`Kredi kartı ile ödeme alındı: ${orderData.totalAmount.toFixed(2)} TL`);

            // Fişi yazdır
            printOrderReceipt(orderData);

            // Sepeti temizle ve sıfırla
            cart = [];
            updateCartDisplay();
            tableNameSelect.value = 'Masa 1';
            customTableNameInput.style.display = 'none';
            currentTableName = 'Masa 1';
        });

        // =========================================================
        // Sayfa Yüklendiğinde
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap(); // Haritayı başlat
            renderCategories(); // POS kategorilerini yükle
            updateCartDisplay(); // Sepeti ilk kez göster

            // Socket.IO olay dinleyicileri
            socket.on('newOrder', (order) => {
                console.log('Yeni sipariş alındı:', order);
                addOrderToDisplay(order);
                playNotificationSound();
                notificationBell.classList.add('ringing');
                setTimeout(() => {
                    notificationBell.classList.remove('ringing');
                }, 1500);
            });

            socket.on('notificationSound', () => {
                playNotificationSound();
                notificationBell.classList.add('ringing');
                setTimeout(() => {
                    notificationBell.classList.remove('ringing');
                }, 1500);
            });

            socket.on('newRiderLocation', (locationData) => {
                updateRiderLocation(locationData);
            });

            socket.on('currentRiderLocations', (locations) => {
                console.log('Mevcut motorcu konumları alındı:', locations);
                for (const riderId in locations) {
                    updateRiderLocation(locations[riderId]);
                }
            });

            socket.on('connect', () => {
                console.log('Sunucuya bağlandı!');
            });

            socket.on('disconnect', () => {
                console.log('Sunucu bağlantısı kesildi!');
                for (const riderId in riderMarkers) {
                    if (riderMarkers[riderId]) {
                        riderMarkers[riderId].remove();
                        delete riderMarkers[riderId];
                    }
                }
            });

            socket.on('connect_error', (err) => {
                console.error('Bağlantı hatası:', err.message);
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Garson POS Sistemi - YÃ¶netim Paneli</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""/>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

<style>
/* GENEL CSS STILLERI */
body {
font-family: 'Inter', sans-serif;
margin: 0px;
background-color: #f4f7f6;
color: #333;
display: flex;
flex-direction: column;
gap: 20px;
min-height: 100vh;
}
.container {
max-width: 1200px;
margin: 20px auto;
padding: 20px;
background-color: #ffffff;
border-radius: 12px;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
flex-grow: 1;
}
.header {
background-color: #2c3e50;
color: #ffffff;
padding: 20px;
border-radius: 12px 12px 0 0;
text-align: center;
margin-bottom: 20px;
}
.section-title {
font-size: 1.8rem;
font-weight: 700;
color: #2c3e50;
margin-bottom: 20px;
text-align: center;
}
.card {
background-color: #fcfcfc;
border-radius: 10px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
padding: 20px;
margin-bottom: 15px;
transition: transform 0.2s ease-in-out;
}
.card:hover {
transform: translateY(-3px);
}
.order-item {
display: flex;
justify-content: space-between;
margin-bottom: 5px;
padding-bottom: 5px;
border-bottom: 1px dashed #eee;
}
.order-item:last-child {
border-bottom: none;
}
.order-status-btn {
padding: 8px 15px;
border-radius: 8px;
font-weight: 600;
cursor: pointer;
transition: background-color 0.3s ease;
}
.status-pending {
background-color: #f39c12;
color: white;
}
.status-paid {
background-color: #27ae60;
color: white;
}
.status-assigned {
background-color: #3498db;
color: white;
}
.status-en_route {
background-color: #e67e22;
color: white;
}
.status-delivered {
background-color: #2ecc71;
color: white;
}
.status-cancelled {
background-color: #e74c3c;
color: white;
opacity: 0.6;
}
.rider-card {
background-color: #ecf0f1;
border-radius: 10px;
padding: 15px;
margin-bottom: 10px;
box-shadow: 0 1px 5px rgba(0, 0, 0, 0.03);
}
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
overflow: auto;
background-color: rgba(0,0,0,0.6);
justify-content: center;
align-items: center;
}
.modal-content {
background-color: #fefefe;
margin: auto;
padding: 30px;
border-radius: 10px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
width: 90%;
max-width: 500px;
animation-name: animatetop;
animation-duration: 0.4s
}
@keyframes animatetop {
from {top: -300px; opacity: 0}
to {top: 0; opacity: 1}
}
.close-button {
color: #aaa;
float: right;
font-size: 28px;
font-weight: bold;
}
.close-button:hover,
.close-button:focus {
color: black;
text-decoration: none;
cursor: pointer;
}
.form-group {
margin-bottom: 15px;
}
.form-group label {
display: block;
margin-bottom: 5px;
font-weight: 600;
color: #555;
}
.form-group input,
.form-group select,
.form-group textarea {
width: 100%;
padding: 10px;
border: 1px solid #ccc;
border-radius: 6px;
box-sizing: border-box;
font-size: 1rem;
}
.btn-primary {
background-color: #3498db;
color: white;
padding: 12px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 1.1rem;
font-weight: 600;
border: none;
transition: background-color 0.3s ease;
}
.btn-primary:hover {
background-color: #2980b9;
}
.btn-secondary {
background-color: #95a5a6;
color: white;
padding: 12px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 1.1rem;
font-weight: 600;
border: none;
transition: background-color 0.3s ease;
}
.btn-secondary:hover {
background-color: #7f8c8d;
}
.map-container {
height: 400px;
width: 100%;
border-radius: 10px;
margin-top: 20px;
overflow: hidden;
}
#notificationSound {
display: none;
}
#main-layout-container {
display: flex;
flex-direction: row;
gap: 20px;
width: 100%;
max-width: 100vw;
justify-content: space-between;
}
#main-content {
flex: 2;
display: flex;
flex-direction: column;
}
#map-container {
flex: 1;
background-color: #fff;
border-radius: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
padding: 15px;
height: 60vh;
position: sticky;
top: 20px;
display: flex;
flex-direction: column;
}
#map {
width: 100%;
flex-grow: 1;
border-radius: 4px;
margin-top: 10px;
}
#orders-container {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
gap: 20px;
margin-top: 20px;
}
.order-card {
background-color: #fff;
border-radius: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
padding: 15px;
border-left: 5px solid #4CAF50;
display: flex;
flex-direction: column;
}
.order-card .order-header {
font-weight: bold;
margin-bottom: 10px;
font-size: 1.1em;
color: #2196F3;
}
.order-card .order-item {
margin-left: 10px;
margin-bottom: 5px;
}
.order-card .order-total {
font-weight: bold;
margin-top: 10px;
text-align: right;
font-size: 1.2em;
color: #333;
border-top: 1px dashed #ccc;
padding-top: 10px;
}
.notification-bell {
position: fixed;
top: 20px;
right: 20px;
width: 50px;
height: 50px;
background-color: #FFC107;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 30px;
color: #fff;
box-shadow: 0 2px 5px rgba(0,0,0,0.2);
animation: none;
z-index: 1000;
}
@keyframes ring {
0% { transform: rotate(0deg); }
10% { transform: rotate(15deg); }
20% { transform: rotate(-15deg); }
30% { transform: rotate(15deg); }
40% { transform: rotate(-15deg); }
50% { transform: rotate(0deg); }
100% { transform: rotate(0deg); }
}
.ringing {
animation: ring 0.5s ease-in-out 3;
}
.order-actions {
display: flex;
gap: 10px;
margin-top: 15px;
}
.pay-button, .print-button, .assign-rider-btn {
flex: 1;
color: white;
border: none;
padding: 10px 15px;
border-radius: 5px;
cursor: pointer;
font-size: 1em;
box-sizing: border-box;
transition: background-color 0.2s ease;
}
.pay-button { background-color: #28a745; }
.pay-button:hover { background-color: #218838; }
.print-button { background-color: #007bff; }
.print-button:hover { background-color: #0056b3; }
.assign-rider-btn { background-color: #f39c12; }
.assign-rider-btn:hover { background-color: #e67e22; }
#order-status-box {
position: absolute;
top: 20px;
left: 20px;
background-color: #ffffff;
border: 1px solid #e0e0e0;
border-radius: 12px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
padding: 12px 20px;
display: flex;
align-items: center;
gap: 15px;
font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
z-index: 1001;
transition: all 0.3s ease;
box-sizing: border-box;
}
#order-status-text {
font-weight: 700;
font-size: 1.1em;
color: #333;
white-space: nowrap;
}
#order-status-toggle {
padding: 10px 18px;
border: none;
border-radius: 8px;
cursor: pointer;
color: white;
font-weight: 600;
font-size: 1em;
min-width: 80px;
text-align: center;
transition: background-color 0.2s ease, transform 0.1s ease;
}
#order-status-toggle:hover {
opacity: 0.9;
transform: translateY(-1px);
}
#order-status-toggle:active {
transform: translateY(0);
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
}
@media print {
body * {
visibility: hidden;
}
.printable-content, .printable-content * {
visibility: visible;
}
.printable-content {
position: absolute;
left: 0;
top: 0;
width: 100%;
}
.order-actions, #map-container, #order-status-box, #notificationBell, h1 {
display: none;
}
@page {
size: 58mm auto;
margin: 0;
}
body {
width: 58mm;
margin: 0;
font-family: 'Consolas', 'Courier New', monospace;
font-size: 10px;
line-height: 1.2;
color: #000;
}
.receipt-container {
padding: 5mm;
box-sizing: border-box;
}
.receipt-header, .receipt-footer {
text-align: center;
margin-bottom: 5px;
font-size: 12px;
}
.receipt-info p, .receipt-item {
margin: 2px 0;
white-space: pre-wrap;
}
.receipt-total {
font-weight: bold;
text-align: right;
margin-top: 10px;
font-size: 11px;
}
hr {
border: 0;
border-top: 1px dashed #888;
margin: 5px 0;
}
}
body.map-only {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
height: 100vh;
overflow: hidden;
padding: 0;
}
body.map-only #main-layout-container {
flex-direction: column;
align-items: center;
width: 100%;
height: 100%;
margin: 0;
gap: 0;
}
body.map-only #main-content {
display: none;
}
body.map-only #map-container {
width: 95%;
height: 95%;
position: relative;
top: auto;
margin-top: 0;
padding: 10px;
box-sizing: border-box;
}
body.map-only #map {
flex-grow: 1;
width: 100%;
height: 100%;
margin-top: 0;
}
body.map-only h1,
body.map-only #order-status-box,
body.map-only #notificationBell,
body.map-only .header-buttons-top { 
display: none;
}
body.map-only #map-container h2 {
display: block;
text-align: center;
margin-bottom: 10px;
font-size: 1.2em;
color: #333;
}
#loginContainer {
display: flex;
justify-content: center;
align-items: center;
min-height: 100vh;
background-color: #f0f2f5;
width: 100%;
}
.login-box {
background-color: #fff;
padding: 40px;
border-radius: 12px;
box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
text-align: center;
width: 100%;
max-width: 400px;
}
.login-box h2 {
margin-bottom: 30px;
color: #333;
font-size: 28px;
}
.login-box label {
display: block;
text-align: left;
margin-bottom: 8px;
font-weight: bold;
color: #555;
}
.login-box input[type="text"],
.login-box input[type="password"] {
width: calc(100% - 24px);
padding: 12px;
margin-bottom: 20px;
border: 1px solid #ddd;
border-radius: 8px;
font-size: 16px;
}
.login-box button {
width: 100%;
padding: 15px;
background-color: #007bff;
color: white;
border: none;
border-radius: 8px;
font-size: 18px;
font-weight: bold;
cursor: pointer;
transition: background-color 0.3s ease;
}
.login-box button:hover {
background-color: #0056b3;
}
.login-box .error-message {
color: #dc3545;
margin-top: 15px;
font-size: 14px;
font-weight: bold;
}
.header-buttons-top {
display: flex;
justify-content: space-between;
align-items: center;
padding: 10px 20px;
background-color: #f07d1e;
color: #ffffff;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.header-buttons-top h1 {
margin: 0;
font-size: 1.5rem;
color: #ffffff;
}
.header-buttons-top .right-buttons {
display: flex;
gap: 10px;
}
.header-buttons-top button {
padding: 8px 15px;
border: none;
border-radius: 5px;
cursor: pointer;
font-size: 0.9em;
color: white;
transition: background-color 0.3s ease;
}
.header-buttons-top #order-status-toggle {
background-color: #28a745;
}
.header-buttons-top #order-status-toggle.disabled {
background-color: #dc3545;
}
.header-buttons-top #logoutButton {
background-color: #dc3545;
}
.header-buttons-top #logoutButton:hover {
background-color: #c82333;
}

/* YENÄ°: KaydÄ±rÄ±labilir Ã¼rÃ¼n listesi stilini ekle */
.order-items-scroll {
    max-height: 150px; /* Sabit yÃ¼kseklik */
    overflow-y: auto;
    padding-right: 5px;
    margin-bottom: 10px;
}

</style>
</head>
<body>
<div id="loginContainer">
<div class="login-box">
<h2>YÃ¶netici GiriÅŸi</h2>
<form id="loginForm">
<label for="username">KullanÄ±cÄ± AdÄ±:</label>
<input type="text" id="username" name="username" required>
<label for="password">Parola:</label>
<input type="password" id="password" name="password" required>
<button type="submit">GiriÅŸ Yap</button>
<div id="loginError" class="error-message"></div>
</form>
</div>
</div>

<div id="adminPanelContent" style="display: none; flex-direction: column; flex-grow: 1;">
<audio id="notificationSound" src="notification.mp3" preload="auto"></audio>
<span id="notificationBell" class="notification-bell">ðŸ””</span>

<div class="header-buttons-top">
<h1>Mutfak / Kasa EkranÄ±</h1>
<div class="right-buttons">
<button id="order-status-toggle">SipariÅŸ AlÄ±mÄ±: YÃ¼kleniyor...</button>
<button id="logoutButton">Ã‡Ä±kÄ±ÅŸ Yap</button>
</div>
</div>

<div class="container" id="main-layout-container">
<div id="main-content">
<h2 class="section-title">Aktif SipariÅŸler</h2>
<div id="orders-container">
<p>Aktif sipariÅŸ bulunamadÄ±.</p>
</div>
</div>

<div id="map-container">
<h2>Motorcu KonumlarÄ± <span id="activeRiderCount" style="font-size: 0.8em; color: #666;">(0 Aktif)</span></h2>
<div id="map"></div>
</div>
</div>
</div>

<div id="assignOrderModal" class="modal">
<div class="modal-content">
<span class="close-button" onclick="closeAssignOrderModal()">&times;</span>
<h3 class="text-xl font-bold mb-4">SipariÅŸi Motorcuya Ata</h3>
<div class="form-group">
<label for="modalOrderId">SipariÅŸ ID:</label>
<input type="text" id="modalOrderId" class="form-control" readonly>
</div>
<div class="form-group">
<label for="modalMasaAdi">Masa AdÄ±:</label>
<input type="text" id="modalMasaAdi" class="form-control" readonly>
</div>
<div class="form-group">
<label for="deliveryAddress">Teslimat Adresi:</label>
<textarea id="deliveryAddress" rows="3" class="form-control" placeholder="MÃ¼ÅŸteri adresi girin" required></textarea>
</div>
<div class="form-group">
<label for="customerPhone">MÃ¼ÅŸteri Telefonu (Opsiyonel):</label>
<input type="text" id="customerPhone" class="form-control" placeholder="MÃ¼ÅŸteri telefon numarasÄ±">
</div>
<div class="form-group">
<label for="paymentMethod">Ã–deme YÃ¶ntemi:</label>
<select id="paymentMethod" class="form-control" required>
<option value="">SeÃ§iniz</option>
<option value="Nakit">Nakit</option>
<option value="Kredi/Banka KartÄ±">Kredi/Banka KartÄ±</option>
<option value="Ticket">Ticket</option>
<option value="Sodexo">Sodexo</option>
<option value="Multinet">Multinet</option>
<option value="Metropol">Metropol</option>
<option value="Setcard">Setcard</option>
</select>
</div>
<div class="form-group">
<label for="selectRider">Motorcu SeÃ§:</label>
<select id="selectRider" class="form-control" required>
<option value="">Aktif Motorcu Yok</option>
</select>
</div>
<div class="flex justify-end space-x-4 mt-6">
<button class="btn-secondary" onclick="closeAssignOrderModal()">Ä°ptal</button>
<button class="btn-primary" onclick="assignOrder()">GÃ¶nder</button>
</div>
</div>
</div>

<script>

// Global DeÄŸiÅŸkenler
const SOCKET_SERVER_URL = 'https://garson-pos-server.onrender.com';
const API_BASE_URL = 'https://garson-pos-server.onrender.com';

const socket = io(SOCKET_SERVER_URL, {
reconnection: true,
reconnectionAttempts: 10,
reconnectionDelay: 1000,
reconnectionDelayMax: 5000,
transports: ['websocket', 'polling']
});

// DOM ReferanslarÄ±
const loginContainer = document.getElementById('loginContainer');
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const adminPanelContent = document.getElementById('adminPanelContent');
const logoutButton = document.getElementById('logoutButton');

const ordersContainer = document.getElementById('orders-container');
const notificationSound = document.getElementById('notificationSound');
const notificationBell = document.getElementById('notificationBell');
const activeRiderCountEl = document.getElementById('activeRiderCount');
const orderStatusToggleButton = document.getElementById('order-status-toggle');

const assignOrderModal = document.getElementById('assignOrderModal');
const modalOrderId = document.getElementById('modalOrderId');
const modalMasaAdi = document.getElementById('modalMasaAdi');
const deliveryAddressInput = document.getElementById('deliveryAddress');
const paymentMethodSelect = document.getElementById('paymentMethod');
const customerPhoneInput = document.getElementById('customerPhone');
const selectRider = document.getElementById('selectRider');
const cancelAssignButton = assignOrderModal.querySelector('.btn-secondary');
const sendAssignButton = assignOrderModal.querySelector('.btn-primary');
const closeModalButton = assignOrderModal.querySelector('.close-button');

let map;
const riderMarkers = {};
const deliveryMarkers = {};
const orders = {};
let currentOrderToAssign = null;
let autoFollow = false; // Mobile uygulamadaki gibi otomatik takip baÅŸlangÄ±Ã§ta kapalÄ± olmalÄ±, kullanÄ±cÄ± aÃ§abilir.

// AUTHENTICATION FONKSÄ°YONLARI
function getAuthToken() {
return localStorage.getItem('authToken');
}

function getUserRole() {
return localStorage.getItem('userRole');
}

async function handleLogin(event) {
event.preventDefault();
const username = loginForm.username.value;
const password = loginForm.password.value;
loginError.textContent = '';

try {
const response = await fetch(`${API_BASE_URL}/api/login`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ username, password })
});

const data = await response.json();

if (response.ok) {
localStorage.setItem('authToken', data.token);
localStorage.setItem('userRole', data.role);
localStorage.setItem('username', data.user.username);
console.log(`GiriÅŸ baÅŸarÄ±lÄ±: ${data.user.username} (${data.role})`);
showAdminPanel();
} else {
loginError.textContent = data.message || 'GiriÅŸ baÅŸarÄ±sÄ±z oldu.';
}
} catch (error) {
console.error('GiriÅŸ sÄ±rasÄ±nda aÄŸ hatasÄ±:', error);
loginError.textContent = 'Sunucuya baÄŸlanÄ±lamadÄ±. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.';
}
}

function performLogout() {
localStorage.clear();
showLogin();
if (map) {
map.remove();
map = null;
}
ordersContainer.innerHTML = '<p>Aktif sipariÅŸ bulunamadÄ±.</p>';
activeRiderCountEl.textContent = '(0 Aktif)';
Object.keys(orders).forEach(key => delete orders[key]);
Object.keys(riderMarkers).forEach(key => {
if (riderMarkers[key]) {
riderMarkers[key].remove();
}
delete riderMarkers[key];
});
Object.keys(deliveryMarkers).forEach(key => {
if (deliveryMarkers[key]) {
deliveryMarkers[key].remove();
}
delete deliveryMarkers[key];
});
socket.disconnect();
}

function showLogin() {
loginContainer.style.display = 'flex';
adminPanelContent.style.display = 'none';
}

async function showAdminPanel() {
loginContainer.style.display = 'none';
adminPanelContent.style.display = 'flex';

const userRole = getUserRole();
if (userRole === 'admin' || userRole === 'garson') {
orderStatusToggleButton.style.display = 'block';
await fetchOrderReceptionStatus();
} else {
orderStatusToggleButton.style.display = 'none';
}

if (!map) {
initMap();
} else {
map.invalidateSize();
}

await fetchCurrentActiveOrders();
}

function checkLoginStatus() {
if (getAuthToken() && (getUserRole() === 'admin' || getUserRole() === 'garson')) {
showAdminPanel();
} else {
showLogin();
}
}

// HARÄ°TA VE KONUM Ä°ÅžLEMLERÄ°
function initMap() {
const initialLat = 41.0248;
const initialLng = 29.1023;

if (document.getElementById('map')) {
if (map) {
map.remove();
}
map = L.map('map').setView([initialLat, initialLng], 17);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {

}).addTo(map);

// YENÄ° EKLE: KullanÄ±cÄ± manuel olarak haritayÄ± kaydÄ±rdÄ±ÄŸÄ±nda otomatik takibi kapat
map.on('movestart', () => {
if (autoFollow === true) {
console.log('KullanÄ±cÄ± manuel kaydÄ±rdÄ±. Otomatik takip kapatÄ±ldÄ±.');
autoFollow = false;
}
});

// Teslimat iÅŸaretleyicileri iÃ§in Ã¶zel ikon
window.deliveryIcon = L.icon({
iconUrl: 'https://cdn-icons-png.flaticon.com/512/1170/1170679.png',
iconSize: [32, 32],
iconAnchor: [16, 16],
popupAnchor: [0, -16]
});

fetchRiderLocations();
} else {
console.error("Harita iÃ§in 'map' ID'sine sahip element bulunamadÄ±!");
}
}

function updateRiderLocationOnMap(locationData) {
const { username, latitude, longitude, fullName } = locationData;
const latLng = [latitude, longitude];

if (!map) {
console.warn('Harita henÃ¼z baÅŸlatÄ±lmadÄ± veya bulunamadÄ±. Konum gÃ¼ncellenemiyor.');
return;
}

// Ä°kon boyutu Android kodunuzdaki 42x42 piksel boyutuna gÃ¶re ayarlandÄ± (yaklaÅŸÄ±k 14 DP)
const customIcon = L.icon({
iconUrl: 'images/motorcu_icon.png',
iconSize: [42, 42], 
iconAnchor: [21, 21], // Ä°konun ortasÄ±na ayarlandÄ±
popupAnchor: [0, -21]
});

if (riderMarkers[username]) {
// Ä°ÅŸaretleyiciyi sadece hareket ettir.
riderMarkers[username].setLatLng(latLng);
if (riderMarkers[username].getPopup()) {
riderMarkers[username].getPopup().setContent(
`<div><strong>Motorcu AdÄ±:</strong> ${fullName || username}</div>` +
`<div><strong>KullanÄ±cÄ± AdÄ± (Sistem):</strong> ${username}</div>` +
`<div><strong>Konum:</strong> ${latitude.toFixed(4)}, ${longitude.toFixed(4)}</div>` +
`<div><strong>HÄ±z:</strong> ${locationData.speed ? (locationData.speed * 3.6).toFixed(2) + ' km/s' : 'Bilinmiyor'}</div>` +
`<div><strong>YÃ¶n:</strong> ${locationData.bearing !== undefined ? locationData.bearing.toFixed(0) + 'Â°' : 'Bilinmiyor'}</div>` +
`<div><strong>Hassasiyet:</strong> ${locationData.accuracy !== undefined ? locationData.accuracy.toFixed(2) + ' m' : 'Bilinmiyor'}</div>` +
`<div><strong>GÃ¼ncellenme:</strong> ${new Date(locationData.timestamp).toLocaleTimeString()}</div>`
);
}
} else {
riderMarkers[username] = L.marker(latLng, { icon: customIcon }).addTo(map)
.bindPopup(
`<div><strong>Motorcu AdÄ±:</strong> ${fullName || username}</div>` +
`<div><strong>KullanÄ±cÄ± AdÄ± (Sistem):</strong> ${username}</div>` +
`<div><strong>Konum:</strong> ${latitude.toFixed(4)}, ${longitude.toFixed(4)}</div>` +
`<div><strong>HÄ±z:</strong> ${locationData.speed ? (locationData.speed * 3.6).toFixed(2) + ' km/s' : 'Bilinmiyor'}</div>` +
`<div><strong>YÃ¶n:</strong> ${locationData.bearing !== undefined ? locationData.bearing.toFixed(0) + 'Â°' : 'Bilinmiyor'}</div>` +
`<div><strong>Hassasiyet:</strong> ${locationData.accuracy !== undefined ? locationData.accuracy.toFixed(2) + ' m' : 'Bilinmiyor'}</div>` +
`<div><strong>GÃ¼ncellenme:</strong> ${new Date(locationData.timestamp).toLocaleTimeString()}</div>`
);
}
updateActiveRiderCount();

// ANLIK KONUM ODAKLAMA MANTIÄžI: (YENÄ° - Sadece 1 motorcu varsa)
if (Object.keys(riderMarkers).length === 1 && autoFollow) {
    // Zoom seviyesi 17 (sokak seviyesi) olarak ayarlandÄ±
    map.setView(latLng, 17, { 
        animate: true,
        pan: {
            duration: 0.5 // YumuÅŸak kaydÄ±rma
        }
    });
}

}

function addDeliveryMarker(order) {
if (!order.deliveryAddress || !order.deliveryLocation) return;

if (deliveryMarkers[order.orderId]) {
deliveryMarkers[order.orderId].remove();
}

const latLng = [order.deliveryLocation.latitude, order.deliveryLocation.longitude];
deliveryMarkers[order.orderId] = L.marker(latLng, {
icon: window.deliveryIcon,
zIndexOffset: 1000
}).addTo(map)
.bindPopup(`
               <div><strong>SipariÅŸ ID:</strong> ${order.orderId.substring(0, 8)}</div>
               <div><strong>Masa:</strong> ${order.masaAdi}</div>
               <div><strong>Adres:</strong> ${order.deliveryAddress}</div>
               ${order.customerPhone ? `<div><strong>Telefon:</strong> ${order.customerPhone}</div>` : ''}
           `);
}

function removeDeliveryMarker(orderId) {
if (deliveryMarkers[orderId]) {
deliveryMarkers[orderId].remove();
delete deliveryMarkers[orderId];
}
}

function updateActiveRiderCount() {
const count = Object.keys(riderMarkers).length;
activeRiderCountEl.textContent = `(${count} Aktif)`;
}

// SÄ°PARÄ°Åž ALIM DURUMU YÃ–NETÄ°MÄ°
async function fetchOrderReceptionStatus() {
const authToken = getAuthToken();
if (!authToken) {
console.error("fetchOrderReceptionStatus: Yetkilendirme token'Ä± bulunamadÄ±.");
return;
}
try {
const response = await fetch(`${API_BASE_URL}/api/order-status`, {
headers: { 'Authorization': `Bearer ${authToken}` }
});
if (!response.ok) {
throw new Error(`HTTP error! status: ${response.status}`);
}
const data = await response.json();
updateOrderReceptionButtonUI(data.enabled);
} catch (error) {
console.error('SipariÅŸ durumu Ã§ekilirken hata oluÅŸtu:', error);
alert('SipariÅŸ durumu alÄ±namadÄ±.');
}
}

async function toggleOrderReceptionStatus() {
const authToken = getAuthToken();
if (!authToken) {
console.error("toggleOrderReceptionStatus: Yetkilendirme token'Ä± bulunamadÄ±.");
alert("Ä°ÅŸlem baÅŸarÄ±sÄ±z: LÃ¼tfen tekrar giriÅŸ yapÄ±n.");
return;
}

const isCurrentlyEnabled = orderStatusToggleButton.classList.contains('enabled');
const newStatus = !isCurrentlyEnabled;

orderStatusToggleButton.textContent = 'GÃ¼ncelleniyor...';
orderStatusToggleButton.disabled = true;

try {
const response = await fetch(`${API_BASE_URL}/api/set-order-status`, {
method: 'POST',
headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
body: JSON.stringify({ enabled: newStatus })
});
if (!response.ok) {
const errorData = await response.json().catch(() => ({}));
throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
}
const data = await response.json();
updateOrderReceptionButtonUI(data.newStatus);
alert(`SipariÅŸ alÄ±mÄ± durumu baÅŸarÄ±yla gÃ¼ncellendi: ${data.newStatus ? 'AÃ‡IK' : 'KAPALI'}`);
} catch (error) {
console.error('SipariÅŸ durumu gÃ¼ncellenirken hata oluÅŸtu:', error);
alert(`SipariÅŸ durumu gÃ¼ncellenemedi: ${error.message}`);
} finally {
orderStatusToggleButton.disabled = false;
}
}

function updateOrderReceptionButtonUI(isEnabled) {
if (isEnabled) {
orderStatusToggleButton.textContent = 'SipariÅŸ AlÄ±mÄ±: AÃ‡IK';
orderStatusToggleButton.classList.remove('disabled');
orderStatusToggleButton.classList.add('enabled');
orderStatusToggleButton.style.backgroundColor = '#28a745';
} else {
orderStatusToggleButton.textContent = 'SipariÅŸ AlÄ±mÄ±: KAPALI';
orderStatusToggleButton.classList.remove('enabled');
orderStatusToggleButton.classList.add('disabled');
orderStatusToggleButton.style.backgroundColor = '#dc3545';
}
}

// SÄ°PARÄ°ÅžLERÄ° RENDER ETME
function renderOrders() {
    const sortedOrders = Object.values(orders).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    ordersContainer.innerHTML = '';

    if (sortedOrders.length === 0) {
        ordersContainer.innerHTML = '<p>Aktif sipariÅŸ bulunamadÄ±.</p>';
        return;
    }

    sortedOrders.forEach(order => {
        const orderCard = document.createElement('div');
        orderCard.id = `order-${order.orderId}`;
        orderCard.className = `card ${getStatusClass(order.deliveryStatus || order.status)}`;
        orderCard.dataset.orderId = order.orderId;

        let riderInfoHtml = '';
        if (order.riderUsername && order.deliveryAddress && order.paymentMethod) {
            riderInfoHtml = `
                       <div class="rider-info">
                           <p class="text-xs text-gray-600 mt-1">Atanan Motorcu: ${order.riderUsername}</p>
                           <p class="text-xs text-gray-600">Teslimat Adresi: ${order.deliveryAddress}</p>
                           ${order.customerPhone ? `<p class="text-xs text-gray-600">Telefon: ${order.customerPhone}</p>` : ''}
                           <p class="text-xs text-gray-600">Ã–deme YÃ¶ntemi: ${order.paymentMethod}</p>
                       </div>
                   `;
        }

        const showAssignButton = (order.deliveryStatus === 'pending' && order.status !== 'paid');

        orderCard.innerHTML = `
                   <h3 class="text-lg font-bold mb-2">Masa: ${order.masaAdi} (ID: ${order.masaId})</h3>
                   <p class="text-gray-700 text-sm mb-1">SipariÅŸ ID: ${order.orderId.substring(0, 8)}...</p>
                   <p class="text-gray-700 text-sm mb-1">Zaman: ${new Date(order.timestamp).toLocaleString()}</p>
                   
                   <div class="mt-3 mb-2">
                       <p class="font-semibold text-gray-800">ÃœrÃ¼nler:</p>
                       <div class="order-items-scroll">
                           ${order.sepetItems.map(item => `
                               <div class="order-item">
                                   <span>${item.urunAdi} x ${item.adet}</span>
                                   <span>${formatPrice(item.fiyat * item.adet)}</span>
                               </div>
                           `).join('')}
                       </div>
                   </div>
                   <p class="text-lg font-bold text-right mt-3">Toplam: ${formatPrice(order.toplamFiyat)}</p>
                   <p class="order-status-text text-sm font-semibold mt-2 ${getStatusClass(order.deliveryStatus || order.status)}">Durum: ${getOrderStatusText(order.status, order.deliveryStatus)}</p>
                   ${riderInfoHtml}

                   <div class="flex justify-end mt-4 space-x-2">
                       <button class="pay-button" onclick="markOrderAsPaid('${order.orderId}')" ${order.status === 'paid' ? 'disabled' : ''}>Ã–dendi Olarak Ä°ÅŸaretle</button>
                       <button class="print-button" onclick="printOrderReceipt('${order.orderId}')">YazdÄ±r</button>
                       ${showAssignButton ? `<button class="assign-rider-btn" onclick="openAssignOrderModal('${order.orderId}')">Motorcuya GÃ¶nder</button>` : ''}
                   </div>
               `;
        ordersContainer.prepend(orderCard);
    });
}

function formatPrice(price) {
return price.toFixed(2).replace('.', ',') + ' TL';
}

function getStatusClass(status) {
switch (status) {
case 'pending': return 'status-pending';
case 'paid': return 'status-paid';
case 'assigned': return 'status-assigned';
case 'en_route': return 'status-en-route';
case 'delivered': return 'status-delivered';
case 'cancelled': return 'status-cancelled';
default: return '';
}
}

function getOrderStatusText(status, deliveryStatus) {
if (deliveryStatus && deliveryStatus !== 'pending') {
switch (deliveryStatus) {
case 'assigned': return 'Motorcuya AtandÄ±';
case 'en_route': return 'Yolda';
case 'delivered': return 'Teslim Edildi';
case 'cancelled': return 'Ä°ptal Edildi';
default: return deliveryStatus;
}
}
switch (status) {
case 'pending': return 'Beklemede';
case 'paid': return 'Ã–dendi';
case 'cancelled': return 'Ä°ptal Edildi';
default: return status;
}
}

function removeOrderFromDisplay(orderId) {
console.log(`removeOrderFromDisplay Ã§aÄŸrÄ±ldÄ±: ${orderId}`);
if (orders[orderId]) {
delete orders[orderId];
renderOrders();
} else {
console.warn(`SipariÅŸ ${orderId} orders objesinde bulunamadÄ±.`);
}
}

function markOrderAsPaid(orderId) {
console.log(`markOrderAsPaid Ã§aÄŸrÄ±ldÄ±: ${orderId}`);
socket.emit('orderPaid', { orderId: orderId });
}

function printOrderReceipt(orderId) {
const order = orders[orderId];
if (!order) {
alert('YazdÄ±rÄ±lacak sipariÅŸ bulunamadÄ±!');
return;
}
let printContent = `
               <div class="receipt-container">
                   <div class="receipt-header">--- Olimpiyat KokoreÃ§ ---</div>
                   <p class="receipt-info">Tel No:0216 335 7920</p>
                   <p class="receipt-info">Masa: ${order.masaAdi}</p>
                   <p class="receipt-info">SipariÅŸ ID: ${order.orderId.substring(0, 8)}...</p>
                   <p class="receipt-info">Zaman: ${new Date(order.timestamp).toLocaleString()}</p>
                   ${order.deliveryAddress ? `<p class="receipt-info">Adres: ${order.deliveryAddress}</p>` : ''}
                   ${order.customerPhone ? `<p class="receipt-info">Telefon: ${order.customerPhone}</p>` : ''}
                   ${order.paymentMethod ? `<p class="receipt-info">Ã–deme: ${order.paymentMethod}</p>` : ''}
                   <hr>
                   <div class="receipt-items">
           `;

order.sepetItems.forEach(item => {
const itemName = item.urunAdi;
const itemQuantity = item.adet;
const itemPrice = item.fiyat;
printContent += `<p class="receipt-item">${itemName} (${itemQuantity} adet) - ${(itemPrice * itemQuantity).toFixed(2)} TL</p>`;
});

printContent += `
                   </div>
                   <hr>
                   <div class="receipt-total">TOPLAM: ${order.toplamFiyat.toFixed(2)} TL</div>
                   <div class="receipt-footer">Afiyet Olsun! TeÅŸekkÃ¼rler!</div>
               </div>
           `;

let printWindow = window.open('', '_blank');
printWindow.document.write('<!DOCTYPE html><html><head><title>FiÅŸ - ' + order.masaAdi + '</title>');
printWindow.document.write('<style>');
printWindow.document.write(`
               @page {
                   size: 58mm auto;
                   margin: 0;
               }
               body {
                   width: 58mm;
                   margin: 0;
                   font-family: 'Roboto Mono', monospace;
                   font-size: 15px;
                   font-weight: 800;
                   line-height: 1.2;
                   color: #000;
               }
               .receipt-container {
                   padding: 5mm;
                   box-sizing: border-box;
               }
               .receipt-header, .receipt-footer {
                   text-align: center;
                   margin-bottom: 5px;
                   font-size: 16px;
               }
               .receipt-info p, .receipt-item {
                   margin: 2px 0;
                   white-space: pre-wrap;
               }
               .receipt-total {
                   font-weight: bold;
                   text-align: right;
                   margin-top: 10px;
                   font-size: 14px;
               }
               hr {
                   border: 0;
                   border-top: 1px dashed #888;
                   margin: 5px 0;
               }
           `);
printWindow.document.write('</style>');
printWindow.document.write('</head><body>');
printWindow.document.write(printContent);
printWindow.document.write('</body></html>');
printWindow.document.close();
printWindow.focus();
printWindow.print();
}

// MOTORCUYA SÄ°PARÄ°Åž ATAMA MODALI FONKSÄ°YONLARI
async function openAssignOrderModal(orderId) {
currentOrderToAssign = orders[orderId];
if (!currentOrderToAssign) {
alert('SipariÅŸ bulunamadÄ±!');
return;
}

modalOrderId.value = currentOrderToAssign.orderId.substring(0, 8);
modalMasaAdi.value = currentOrderToAssign.masaAdi;
deliveryAddressInput.value = '';
customerPhoneInput.value = '';
paymentMethodSelect.value = '';

await fetchAndPopulateRiders();

assignOrderModal.style.display = 'flex';
}

function closeAssignOrderModal() {
assignOrderModal.style.display = 'none';
currentOrderToAssign = null;
}

async function fetchAndPopulateRiders() {
selectRider.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
try {
const response = await fetch(`${API_BASE_URL}/api/riders-locations`, {
headers: {
'Authorization': `Bearer ${getAuthToken()}`
}
});

if (!response.ok) {
const errorData = await response.json().catch(() => ({}));
throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
}

const riders = await response.json();

selectRider.innerHTML = '';
if (!Array.isArray(riders) || riders.length === 0) {
selectRider.innerHTML = '<option value="">Aktif Motorcu Yok</option>';
selectRider.disabled = true;
} else {
selectRider.disabled = false;
selectRider.innerHTML = '<option value="">Motorcu SeÃ§iniz</option>';
riders.forEach(rider => {
const option = document.createElement('option');
option.value = rider.username;
option.textContent = rider.full_name || rider.username;
selectRider.appendChild(option);
});
}
} catch (error) {
console.error('Motorcular Ã§ekilirken hata:', error);
selectRider.innerHTML = '<option value="">Motorcular yÃ¼klenemedi</option>';
selectRider.disabled = true;
}
}

async function assignOrder() {
if (!currentOrderToAssign) return;

const deliveryAddress = deliveryAddressInput.value.trim();
const paymentMethod = paymentMethodSelect.value;
const selectedRider = selectRider.value;
const customerPhone = customerPhoneInput.value.trim();

if (!deliveryAddress || !paymentMethod || !selectedRider) {
alert('LÃ¼tfen zorunlu alanlarÄ± doldurun ve bir motorcu seÃ§in.');
return;
}

try {
// Adres koordinatlarÄ±nÄ± almak iÃ§in geocoding API'si kullanÄ±mÄ±
const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(deliveryAddress)}`);
const geocodeData = await geocodeResponse.json();

if (!geocodeData || geocodeData.length === 0) {
throw new Error('Adres bulunamadÄ±');
}

const location = {
latitude: parseFloat(geocodeData[0].lat),
longitude: parseFloat(geocodeData[0].lon)
};

const authToken = getAuthToken();
const response = await fetch(`${API_BASE_URL}/api/assign-order`, {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${authToken}`
},
body: JSON.stringify({
orderId: currentOrderToAssign.orderId,
riderUsername: selectedRider,
deliveryAddress: deliveryAddress,
deliveryLocation: location,
paymentMethod: paymentMethod,
customerPhone: customerPhone || null
})
});

const data = await response.json();

if (response.ok) {
alert('SipariÅŸ baÅŸarÄ±yla motorcuya atandÄ±!');
closeAssignOrderModal();
} else {
alert(`SipariÅŸ atama hatasÄ±: ${data.message || response.statusText}`);
}
} catch (error) {
console.error('SipariÅŸ atanÄ±rken hata:', error);
alert(`SipariÅŸ atanamadÄ±: ${error.message}`);
}
}

// API Ä°STEKLERÄ°
async function fetchCurrentActiveOrders() {
const authToken = getAuthToken();
if (!authToken) {
console.error("fetchCurrentActiveOrders: Yetkilendirme token'Ä± bulunamadÄ±.");
ordersContainer.innerHTML = '<p>SipariÅŸler yÃ¼klenemedi: Yetkilendirme hatasÄ±.</p>';
return;
}

try {
const response = await fetch(`${API_BASE_URL}/api/orders/active`, {
headers: { 'Authorization': `Bearer ${authToken}` }
});

if (!response.ok) {
const errorData = await response.json().catch(() => ({}));
throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
}

const fetchedOrders = await response.json();
Object.keys(orders).forEach(key => delete orders[key]);
fetchedOrders.forEach(order => {
orders[order.orderId] = order;
if (order.deliveryLocation) {
addDeliveryMarker(order);
}
});
renderOrders();
} catch (error) {
console.error('Aktif sipariÅŸler Ã§ekilirken hata:', error);
ordersContainer.innerHTML = `<p>SipariÅŸler yÃ¼klenemedi: ${error.message}</p>`;
}
}

async function fetchRiderLocations() {
const authToken = getAuthToken();
if (!authToken) {
console.error("fetchRiderLocations: Yetkilendirme token'Ä± bulunamadÄ±.");
activeRiderCountEl.textContent = 'Motorcu konumlarÄ± yÃ¼klenemedi: Yetkilendirme hatasÄ±.';
return;
}

try {
const response = await fetch(`${API_BASE_URL}/api/riders-locations`, {
headers: { 'Authorization': `Bearer ${authToken}` }
});

if (!response.ok) {
const errorData = await response.json().catch(() => ({}));
throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
}

const locations = await response.json();
console.log("Motorcu konumlarÄ±:", locations);

if (!Array.isArray(locations)) {
console.error("API'den beklenen motorcu konum listesi bir dizi deÄŸil:", locations);
alert("Motorcu konumlarÄ± yÃ¼klenemedi: Sunucudan hatalÄ± veri formatÄ± alÄ±ndÄ±.");
activeRiderCountEl.textContent = 'Motorcu konumlarÄ± yÃ¼klenemedi: HatalÄ± veri.';
return;
}

// TÃ¼m markerlarÄ± sil
Object.values(riderMarkers).forEach(marker => marker.remove());
Object.keys(riderMarkers).forEach(key => delete riderMarkers[key]);

// Yenilerini ekle
const bounds = new L.LatLngBounds();
locations.forEach(locationData => {
updateRiderLocationOnMap(locationData);
bounds.extend([locationData.latitude, locationData.longitude]);
});

updateActiveRiderCount();

// HaritayÄ± tÃ¼m motorculara gÃ¶re ortala (tek motorcu varsa zoom 14)
if (map && Object.keys(riderMarkers).length > 0) {
if (Object.keys(riderMarkers).length > 1) {
map.fitBounds(bounds.pad(0.1));
} else {
const singleMarker = Object.values(riderMarkers)[0];
// Tek motorcu varsa web paneli iÃ§in 14'e zoom yap
map.setView(singleMarker.getLatLng(), 14); 
}
}
} catch (error) {
console.error('Motorcu konumlarÄ± Ã§ekilirken hata:', error);
activeRiderCountEl.textContent = `Motorcu konumlarÄ± yÃ¼klenemedi: ${error.message}`;
}
}

function removeRiderFromDisplay(username) {
if (riderMarkers[username]) {
riderMarkers[username].remove();
delete riderMarkers[username];
updateActiveRiderCount();
}
}

// Olay Dinleyicileri ve BaÅŸlangÄ±Ã§ KodlarÄ±
document.addEventListener('DOMContentLoaded', () => {
    
    // YENÄ°: DÃ¼zeltilmiÅŸ 'map_only' mantÄ±ÄŸÄ± buraya eklendi.
    const params = new URLSearchParams(window.location.search);
    if (params.get('view') === 'map_only') {
        console.log('Sadece harita gÃ¶rÃ¼nÃ¼mÃ¼ etkinleÅŸtirildi.');
        // CSS dosyanÄ±zda (inline <style> tag'i iÃ§inde) zaten var olan
        // 'map-only' sÄ±nÄ±fÄ±nÄ± body'e ekliyoruz.
        document.body.classList.add('map-only');
    }
    
    // Mevcut dinleyicileriniz
    loginForm.addEventListener('submit', handleLogin);
    logoutButton.addEventListener('click', performLogout);
    orderStatusToggleButton.addEventListener('click', toggleOrderReceptionStatus);

    closeModalButton.addEventListener('click', closeAssignOrderModal);
    cancelAssignButton.addEventListener('click', closeAssignOrderModal);
    sendAssignButton.addEventListener('click', assignOrder);

    window.addEventListener('click', (event) => {
        if (event.target == assignOrderModal) {
            closeAssignOrderModal();
        }
    });

    notificationBell.addEventListener('click', () => {
        notificationBell.classList.remove('ringing');
    });

    checkLoginStatus();
});

window.addEventListener('resize', () => {
if (map) {
map.invalidateSize();
}
});

// Socket.IO Olay Dinleyicileri
socket.on('connect', () => {
console.log('Socket.IO BaÄŸlandÄ±:', socket.id);
const username = localStorage.getItem('username');
const role = getUserRole();
if (username && role) {
socket.emit('registerClient', { username, role });
console.log(`Socket.IO ile kayÄ±t gÃ¶nderildi: ${username} (${role})`);
}
if (getAuthToken()) {
fetchCurrentActiveOrders();
fetchRiderLocations();
fetchOrderReceptionStatus();
}
});

socket.on('connect_error', (error) => {
console.error('Socket.IO BaÄŸlantÄ± HatasÄ±:', error);
});

socket.on('disconnect', (reason) => {
console.log('Socket.IO BaÄŸlantÄ±sÄ± Kesildi. Neden:', reason);
});

socket.on('reconnect', (attemptNumber) => {
console.log('Socket.IO Yeniden BaÄŸlandÄ±. Deneme:', attemptNumber);
const username = localStorage.getItem('username');
const role = getUserRole();
if (username && role) {
socket.emit('registerClient', { username, role });
console.log(`Socket.IO ile yeniden kayÄ±t gÃ¶nderildi: ${username} (${role})`);
}
if (getAuthToken()) {
fetchCurrentActiveOrders();
fetchRiderLocations();
fetchOrderReceptionStatus();
}
});

socket.on('newOrder', (order) => {
console.log('Yeni sipariÅŸ alÄ±ndÄ±:', JSON.stringify(order, null, 2));
if (order && order.orderId) {
orders[order.orderId] = order;
renderOrders();
notificationSound.play().catch(err => console.error('Bildirim sesi oynatÄ±lamadÄ±:', err));
notificationBell.classList.add('ringing');
setTimeout(() => {
notificationBell.classList.remove('ringing');
}, 1500);
} else {
console.error('GeÃ§ersiz sipariÅŸ verisi:', order);
}
});

socket.on('orderPaidConfirmation', (data) => {
console.log('SipariÅŸ Ã¶dendi onayÄ± alÄ±ndÄ±:', JSON.stringify(data, null, 2));
if (orders[data.orderId]) {
orders[data.orderId].status = 'paid';
renderOrders();
} else {
console.warn(`SipariÅŸ ${data.orderId} orders objesinde bulunamadÄ±.`);
}
});

socket.on('removeOrderFromDisplay', (data) => {
console.log('SipariÅŸ ekrandan kaldÄ±rÄ±lÄ±yor:', JSON.stringify(data, null, 2));
removeOrderFromDisplay(data.orderId);
removeDeliveryMarker(data.orderId);
});

socket.on('orderTakingStatusChanged', (data) => {
console.log('SipariÅŸ alÄ±m durumu deÄŸiÅŸti:', data.enabled);
updateOrderReceptionButtonUI(data.enabled);
});

socket.on('currentActiveOrders', (currentOrders) => {
console.log('Mevcut aktif sipariÅŸler alÄ±ndÄ±:', currentOrders.length);
Object.keys(orders).forEach(key => delete orders[key]);
Object.keys(deliveryMarkers).forEach(key => {
if (deliveryMarkers[key]) {
deliveryMarkers[key].remove();
}
delete deliveryMarkers[key];
});

currentOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
currentOrders.forEach(order => {
orders[order.orderId] = order;
if (order.deliveryLocation) {
addDeliveryMarker(order);
}
});
renderOrders();
});

socket.on('newRiderLocation', (rider) => {
console.log('Yeni motorcu konumu alÄ±ndÄ±:', rider.username, rider.latitude, rider.longitude);
updateRiderLocationOnMap(rider);
updateActiveRiderCount();
});

socket.on('currentRiderLocations', (currentRiders) => {
console.log('Mevcut motorcu konumlarÄ± Socket.IO Ã¼zerinden alÄ±ndÄ±:', currentRiders.length);
const activeUsernames = new Set();
const bounds = new L.LatLngBounds();

// TÃ¼m markerlarÄ± sil
Object.values(riderMarkers).forEach(marker => marker.remove());
Object.keys(riderMarkers).forEach(key => delete riderMarkers[key]);


if (Array.isArray(currentRiders)) {
currentRiders.forEach(rider => {
updateRiderLocationOnMap(rider);
activeUsernames.add(rider.username);
bounds.extend([rider.latitude, rider.longitude]);
});
} else if (typeof currentRiders === 'object' && currentRiders !== null) {
Object.values(currentRiders).forEach(rider => {
updateRiderLocationOnMap(rider);
activeUsernames.add(rider.username);
bounds.extend([rider.latitude, rider.longitude]);
});
} else {
console.warn('currentRiderLocations olayÄ± geÃ§ersiz veri formatÄ± aldÄ±:', currentRiders);
}

updateActiveRiderCount();

// HaritayÄ± tÃ¼m motorculara gÃ¶re ortala
if (map && Object.keys(riderMarkers).length > 0) {
if (Object.keys(riderMarkers).length > 1) {
map.fitBounds(bounds.pad(0.1));
} else {
const singleMarker = Object.values(riderMarkers)[0];
map.setView(singleMarker.getLatLng(), 14); // Tek motorcu varsa zoom 14
}
}
});

socket.on('riderDisconnected', (username) => {
console.log(`riderDisconnected olayÄ± alÄ±ndÄ±: ${username}`);
removeRiderFromDisplay(username);
});

socket.on('orderAssigned', (order) => {
console.log('SipariÅŸ atandÄ± (Socket.IO):', order.orderId, 'Motorcu:', order.riderUsername);
if (orders[order.orderId]) {
orders[order.orderId] = order;
renderOrders();
if (order.deliveryLocation) {
addDeliveryMarker(order);
}
}
});

socket.on('orderDeliveryStatusUpdated', (data) => {
console.log('SipariÅŸ teslimat durumu gÃ¼ncellendi (Socket.IO):', data.orderId, 'Yeni Durum:', data.newDeliveryStatus);
if (orders[data.orderId]) {
orders[data.orderId].deliveryStatus = data.newDeliveryStatus;
renderOrders();
if (data.newDeliveryStatus === 'delivered') {
removeDeliveryMarker(data.orderId);
}
}
});

socket.on('riderDayEnded', (data) => {
console.log('Motorcu gÃ¼nÃ¼ sonlandÄ±rdÄ± (Socket.IO):', data.username, 'Teslim Edilen Paket:', data.deliveredCount);
removeRiderFromDisplay(data.username);
alert(`${data.username} adlÄ± motorcu gÃ¼nÃ¼nÃ¼ sonlandÄ±rdÄ±. BugÃ¼n ${data.deliveredCount} paket teslim etti.`);
});
</script>
</body>
</html>

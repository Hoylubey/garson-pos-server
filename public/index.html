<!-- index.html (Güncellenmiş) -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Garson POS Sistemi - Yönetim Paneli</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

<style>
/* GENEL CSS STILLERI */
body {
font-family: 'Inter', sans-serif;
margin: 0px;
background-color: #f4f7f6;
color: #333;
display: flex;
flex-direction: column;
gap: 20px;
min-height: 100vh;
}
.container {
max-width: 1200px;
margin: 20px auto;
padding: 20px;
background-color: #ffffff;
border-radius: 12px;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
flex-grow: 1;
}
.header {
background-color: #2c3e50;
color: #ffffff;
padding: 20px;
border-radius: 12px 12px 0 0;
text-align: center;
margin-bottom: 20px;
}
.section-title {
font-size: 1.8rem;
font-weight: 700;
color: #2c3e50;
margin-bottom: 20px;
text-align: center;
}
.card {
background-color: #fcfcfc;
border-radius: 10px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
padding: 20px;
margin-bottom: 15px;
transition: transform 0.2s ease-in-out;
}
.card:hover {
transform: translateY(-3px);
}
.order-item {
display: flex;
justify-content: space-between;
margin-bottom: 5px;
padding-bottom: 5px;
border-bottom: 1px dashed #eee;
}
.order-item:last-child {
border-bottom: none;
}
.order-status-btn {
padding: 8px 15px;
border-radius: 8px;
font-weight: 600;
cursor: pointer;
transition: background-color 0.3s ease;
}
.status-pending {
background-color: #f39c12;
color: white;
}
.status-paid {
background-color: #27ae60;
color: white;
}
.status-assigned {
background-color: #3498db;
color: white;
}
.status-en_route {
background-color: #e67e22;
color: white;
}
.status-delivered {
background-color: #2ecc71;
color: white;
}
.status-cancelled {
background-color: #e74c3c;
color: white;
opacity: 0.6;
}
.rider-card {
background-color: #ecf0f1;
border-radius: 10px;
padding: 15px;
margin-bottom: 10px;
box-shadow: 0 1px 5px rgba(0, 0, 0, 0.03);
}
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
overflow: auto;
background-color: rgba(0,0,0,0.6);
justify-content: center;
align-items: center;
}
.modal-content {
background-color: #fefefe;
margin: auto;
padding: 30px;
border-radius: 10px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
width: 90%;
max-width: 500px;
animation-name: animatetop;
animation-duration: 0.4s
}
@keyframes animatetop {
from {top: -300px; opacity: 0}
to {top: 0; opacity: 1}
}
.close-button {
color: #aaa;
float: right;
font-size: 28px;
font-weight: bold;
}
.close-button:hover,
.close-button:focus {
color: black;
text-decoration: none;
cursor: pointer;
}
.form-group {
margin-bottom: 15px;
}
.form-group label {
display: block;
margin-bottom: 5px;
font-weight: 600;
color: #555;
}
.form-group input,
.form-group select,
.form-group textarea {
width: 100%;
padding: 10px;
border: 1px solid #ccc;
border-radius: 6px;
box-sizing: border-box;
font-size: 1rem;
}
.btn-primary {
background-color: #3498db;
color: white;
padding: 12px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 1.1rem;
font-weight: 600;
border: none;
transition: background-color 0.3s ease;
}
.btn-primary:hover {
background-color: #2980b9;
}
.btn-secondary {
background-color: #95a5a6;
color: white;
padding: 12px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 1.1rem;
font-weight: 600;
border: none;
transition: background-color 0.3s ease;
}
.btn-secondary:hover {
background-color: #7f8c8d;
}
.map-container {
height: 400px;
width: 100%;
border-radius: 10px;
margin-top: 20px;
overflow: hidden;
}
#notificationSound {
display: none;
}
#main-layout-container {
display: flex;
flex-direction: row;
gap: 20px;
width: 100%;
max-width: 100vw;
justify-content: space-between;
}
#main-content {
flex: 2;
display: flex;
flex-direction: column;
}
#map-container {
flex: 1;
background-color: #fff;
border-radius: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
padding: 15px;
height: 80vh;
position: sticky;
top: 20px;
display: flex;
flex-direction: column;
}
#map {
width: 100%;
flex-grow: 1;
border-radius: 4px;
margin-top: 10px;
}
#orders-container {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
gap: 20px;
margin-top: 20px;
}
.order-card {
background-color: #fff;
border-radius: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
padding: 15px;
border-left: 5px solid #4CAF50;
display: flex;
flex-direction: column;
}
.order-card .order-header {
font-weight: bold;
margin-bottom: 10px;
font-size: 1.1em;
color: #2196F3;
}
.order-card .order-item {
margin-left: 10px;
margin-bottom: 5px;
}
.order-card .order-total {
font-weight: bold;
margin-top: 10px;
text-align: right;
font-size: 1.2em;
color: #333;
border-top: 1px dashed #ccc;
padding-top: 10px;
}
.notification-bell {
position: fixed;
top: 20px;
right: 20px;
width: 50px;
height: 50px;
background-color: #FFC107;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 30px;
color: #fff;
box-shadow: 0 2px 5px rgba(0,0,0,0.2);
animation: none;
z-index: 1000;
}
@keyframes ring {
0% { transform: rotate(0deg); }
10% { transform: rotate(15deg); }
20% { transform: rotate(-15deg); }
30% { transform: rotate(15deg); }
40% { transform: rotate(-15deg); }
50% { transform: rotate(0deg); }
100% { transform: rotate(0deg); }
}
.ringing {
animation: ring 0.5s ease-in-out 3;
}
.order-actions {
display: flex;
gap: 10px;
margin-top: 15px;
}
.pay-button, .print-button, .assign-rider-btn {
flex: 1;
color: white;
border: none;
padding: 10px 15px;
border-radius: 5px;
cursor: pointer;
font-size: 1em;
box-sizing: border-box;
transition: background-color 0.2s ease;
}
.pay-button { background-color: #28a745; }
.pay-button:hover { background-color: #218838; }
.print-button { background-color: #007bff; }
.print-button:hover { background-color: #0056b3; }
.assign-rider-btn { background-color: #f39c12; }
.assign-rider-btn:hover { background-color: #e67e22; }
#order-status-box {
position: absolute;
top: 20px;
left: 20px;
background-color: #ffffff;
border: 1px solid #e0e0e0;
border-radius: 12px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
padding: 12px 20px;
display: flex;
align-items: center;
gap: 15px;
font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
z-index: 1001;
transition: all 0.3s ease;
box-sizing: border-box;
}
#order-status-text {
font-weight: 700;
font-size: 1.1em;
color: #333;
white-space: nowrap;
}
#order-status-toggle {
padding: 10px 18px;
border: none;
border-radius: 8px;
cursor: pointer;
color: white;
font-weight: 600;
font-size: 1em;
min-width: 80px;
text-align: center;
transition: background-color 0.2s ease, transform 0.1s ease;
}
#order-status-toggle:hover {
opacity: 0.9;
transform: translateY(-1px);
}
#order-status-toggle:active {
transform: translateY(0);
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
}
@media print {
body * {
visibility: hidden;
}
.printable-content, .printable-content * {
visibility: visible;
}
.printable-content {
position: absolute;
left: 0;
top: 0;
width: 100%;
}
.order-actions, #map-container, #order-status-box, #notificationBell, h1 {
display: none;
}
@page {
size: 58mm auto;
margin: 0;
}
body {
width: 58mm;
margin: 0;
font-family: 'Consolas', 'Courier New', monospace;
font-size: 10px;
line-height: 1.2;
color: #000;
}
.receipt-container {
padding: 5mm;
box-sizing: border-box;
}
.receipt-header, .receipt-footer {
text-align: center;
margin-bottom: 5px;
font-size: 12px;
}
.receipt-info p, .receipt-item {
margin: 2px 0;
white-space: pre-wrap;
}
.receipt-total {
font-weight: bold;
text-align: right;
margin-top: 10px;
font-size: 11px;
}
hr {
border: 0;
border-top: 1px dashed #888;
margin: 5px 0;
}
}
body.map-only {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
height: 100vh;
overflow: hidden;
padding: 0;
}
body.map-only #main-layout-container {
flex-direction: column;
align-items: center;
width: 100%;
height: 100%;
margin: 0;
gap: 0;
}
body.map-only #main-content {
display: none;
}
body.map-only #map-container {
width: 95%;
height: 95%;
position: relative;
top: auto;
margin-top: 0;
padding: 10px;
box-sizing: border-box;
}
body.map-only #map {
flex-grow: 1;
width: 100%;
height: 100%;
margin-top: 0;
}
body.map-only h1,
body.map-only #order-status-box,
body.map-only #notificationBell {
display: none;
}
body.map-only #map-container h2 {
display: block;
text-align: center;
margin-bottom: 10px;
font-size: 1.2em;
color: #333;
}
#loginContainer {
display: flex;
justify-content: center;
align-items: center;
min-height: 100vh;
background-color: #f0f2f5;
width: 100%;
}
.login-box {
background-color: #fff;
padding: 40px;
border-radius: 12px;
box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
text-align: center;
width: 100%;
max-width: 400px;
}
.login-box h2 {
margin-bottom: 30px;
color: #333;
font-size: 28px;
}
.login-box label {
display: block;
text-align: left;
margin-bottom: 8px;
font-weight: bold;
color: #555;
}
.login-box input[type="text"],
.login-box input[type="password"] {
width: calc(100% - 24px);
padding: 12px;
margin-bottom: 20px;
border: 1px solid #ddd;
border-radius: 8px;
font-size: 16px;
}
.login-box button {
width: 100%;
padding: 15px;
background-color: #007bff;
color: white;
border: none;
border-radius: 8px;
font-size: 18px;
font-weight: bold;
cursor: pointer;
transition: background-color 0.3s ease;
}
.login-box button:hover {
background-color: #0056b3;
}
.login-box .error-message {
color: #dc3545;
margin-top: 15px;
font-size: 14px;
font-weight: bold;
}
.header-buttons-top {
display: flex;
justify-content: space-between;
align-items: center;
padding: 10px 20px;
background-color: #2c3e50;
color: #ffffff;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.header-buttons-top h1 {
margin: 0;
font-size: 1.5rem;
color: #ffffff;
}
.header-buttons-top .right-buttons {
display: flex;
gap: 10px;
}
.header-buttons-top button {
padding: 8px 15px;
border: none;
border-radius: 5px;
cursor: pointer;
font-size: 0.9em;
color: white;
transition: background-color 0.3s ease;
}
.header-buttons-top #order-status-toggle {
background-color: #28a745;
}
.header-buttons-top #order-status-toggle.disabled {
background-color: #dc3545;
}
.header-buttons-top #logoutButton {
background-color: #dc3545;
}
.header-buttons-top #logoutButton:hover {
background-color: #c82333;
}
</style>
</head>
<body>
<!-- Giriş Ekranı -->
<div id="loginContainer">
<div class="login-box">
<h2>Yönetici Girişi</h2>
<form id="loginForm">
<label for="username">Kullanıcı Adı:</label>
<input type="text" id="username" name="username" required>
<label for="password">Parola:</label>
<input type="password" id="password" name="password" required>
<button type="submit">Giriş Yap</button>
<div id="loginError" class="error-message"></div>
</form>
</div>
</div>

<!-- Admin Paneli İçeriği (Girişten Sonra Görünür) -->
<div id="adminPanelContent" style="display: none; flex-direction: column; flex-grow: 1;">
<audio id="notificationSound" src="notification.mp3" preload="auto"></audio>
<span id="notificationBell" class="notification-bell">🔔</span>

<div class="header-buttons-top">
<h1>Mutfak / Kasa Ekranı</h1>
<div class="right-buttons">
<button id="order-status-toggle">Sipariş Alımı: Yükleniyor...</button>
<button id="logoutButton">Çıkış Yap</button>
</div>
</div>

<div class="container" id="main-layout-container">
<div id="main-content">
<h2 class="section-title">Aktif Siparişler</h2>
<div id="orders-container">
<!-- Sipariş kartları buraya JavaScript ile eklenecek -->
<p>Aktif sipariş bulunamadı.</p>
</div>
</div>

<div id="map-container">
<h2>Motorcu Konumları <span id="activeRiderCount" style="font-size: 0.8em; color: #666;">(0 Aktif)</span></h2>
<div id="map"></div>
</div>
</div>
</div>

<!-- Motorcuya Sipariş Gönder Modalı -->
<div id="assignOrderModal" class="modal">
<div class="modal-content">
<span class="close-button" onclick="closeAssignOrderModal()">&times;</span>
<h3 class="text-xl font-bold mb-4">Siparişi Motorcuya Ata</h3>
<div class="form-group">
<label for="modalOrderId">Sipariş ID:</label>
<input type="text" id="modalOrderId" class="form-control" readonly>
</div>
<div class="form-group">
<label for="modalMasaAdi">Masa Adı:</label>
<input type="text" id="modalMasaAdi" class="form-control" readonly>
</div>
<div class="form-group">
<label for="deliveryAddress">Teslimat Adresi:</label>
<textarea id="deliveryAddress" rows="3" class="form-control" placeholder="Müşteri adresi girin" required></textarea>
</div>
<div class="form-group">
<label for="customerPhone">Müşteri Telefonu (Opsiyonel):</label>
<input type="text" id="customerPhone" class="form-control" placeholder="Müşteri telefon numarası">
</div>
<div class="form-group">
<label for="paymentMethod">Ödeme Yöntemi:</label>
<select id="paymentMethod" class="form-control" required>
<option value="">Seçiniz</option>
<option value="Nakit">Nakit</option>
<option value="Kredi/Banka Kartı">Kredi/Banka Kartı</option>
<option value="Ticket">Ticket</option>
<option value="Sodexo">Sodexo</option>
<option value="Multinet">Multinet</option>
<option value="Metropol">Metropol</option>
<option value="Setcard">Setcard</option>
</select>
</div>
<div class="form-group">
<label for="selectRider">Motorcu Seç:</label>
<select id="selectRider" class="form-control" required>
<option value="">Aktif Motorcu Yok</option>
</select>
</div>
<div class="flex justify-end space-x-4 mt-6">
<button class="btn-secondary" onclick="closeAssignOrderModal()">İptal</button>
<button class="btn-primary" onclick="assignOrder()">Gönder</button>
</div>
</div>
</div>

<script>

        // Sayfa yüklendiğinde URL parametresini kontrol et ve görünümü ayarla
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('view') === 'map_only') {
                console.log('Sadece harita görünümü etkinleştirildi.');
                const mainContainer = document.querySelector('.flex.h-screen');
                if (mainContainer) {
                    mainContainer.style.flexDirection = 'column';
                    mainContainer.style.height = '100vh';
                }
        
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.style.flexGrow = '1';
                }
        
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.style.display = 'none';
                }
        
                const controls = document.getElementById('controls');
                if (controls) {
                    controls.style.display = 'none';
                }
        
                // Dilersen başka gizlemek istediğin elementler varsa buraya ekleyebilirsin.
            }
        });
// Global Değişkenler
const SOCKET_SERVER_URL = 'https://garson-pos-server.onrender.com';
const API_BASE_URL = 'https://garson-pos-server.onrender.com';

const socket = io(SOCKET_SERVER_URL, {
reconnection: true,
reconnectionAttempts: 10,
reconnectionDelay: 1000,
reconnectionDelayMax: 5000,
transports: ['websocket', 'polling']
});

// DOM Referansları
const loginContainer = document.getElementById('loginContainer');
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const adminPanelContent = document.getElementById('adminPanelContent');
const logoutButton = document.getElementById('logoutButton');

const ordersContainer = document.getElementById('orders-container');
const notificationSound = document.getElementById('notificationSound');
const notificationBell = document.getElementById('notificationBell');
const activeRiderCountEl = document.getElementById('activeRiderCount');
const orderStatusToggleButton = document.getElementById('order-status-toggle');

const assignOrderModal = document.getElementById('assignOrderModal');
const modalOrderId = document.getElementById('modalOrderId');
const modalMasaAdi = document.getElementById('modalMasaAdi');
const deliveryAddressInput = document.getElementById('deliveryAddress');
const paymentMethodSelect = document.getElementById('paymentMethod');
const customerPhoneInput = document.getElementById('customerPhone');
const selectRider = document.getElementById('selectRider');
const cancelAssignButton = assignOrderModal.querySelector('.btn-secondary');
const sendAssignButton = assignOrderModal.querySelector('.btn-primary');
const closeModalButton = assignOrderModal.querySelector('.close-button');

let map;
const riderMarkers = {};
const deliveryMarkers = {};
const orders = {};
let currentOrderToAssign = null;

// AUTHENTICATION FONKSİYONLARI
function getAuthToken() {
return localStorage.getItem('authToken');
}

function getUserRole() {
return localStorage.getItem('userRole');
}

async function handleLogin(event) {
event.preventDefault();
const username = loginForm.username.value;
const password = loginForm.password.value;
loginError.textContent = '';

try {
const response = await fetch(`${API_BASE_URL}/api/login`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ username, password })
});

const data = await response.json();

if (response.ok) {
localStorage.setItem('authToken', data.token);
localStorage.setItem('userRole', data.role);
localStorage.setItem('username', data.user.username);
console.log(`Giriş başarılı: ${data.user.username} (${data.role})`);
showAdminPanel();
} else {
loginError.textContent = data.message || 'Giriş başarısız oldu.';
}
} catch (error) {
console.error('Giriş sırasında ağ hatası:', error);
loginError.textContent = 'Sunucuya bağlanılamadı. Lütfen internet bağlantınızı kontrol edin.';
}
}

function performLogout() {
localStorage.clear();
showLogin();
if (map) {
map.remove();
map = null;
}
ordersContainer.innerHTML = '<p>Aktif sipariş bulunamadı.</p>';
activeRiderCountEl.textContent = '(0 Aktif)';
Object.keys(orders).forEach(key => delete orders[key]);
Object.keys(riderMarkers).forEach(key => {
if (riderMarkers[key]) {
riderMarkers[key].remove();
}
delete riderMarkers[key];
});
Object.keys(deliveryMarkers).forEach(key => {
if (deliveryMarkers[key]) {
deliveryMarkers[key].remove();
}
delete deliveryMarkers[key];
});
socket.disconnect();
}

function showLogin() {
loginContainer.style.display = 'flex';
adminPanelContent.style.display = 'none';
}

async function showAdminPanel() {
loginContainer.style.display = 'none';
adminPanelContent.style.display = 'flex';

const userRole = getUserRole();
if (userRole === 'admin' || userRole === 'garson') {
orderStatusToggleButton.style.display = 'block';
await fetchOrderReceptionStatus();
} else {
orderStatusToggleButton.style.display = 'none';
}

if (!map) {
initMap();
} else {
map.invalidateSize();
}

await fetchCurrentActiveOrders();
}

function checkLoginStatus() {
if (getAuthToken() && (getUserRole() === 'admin' || getUserRole() === 'garson')) {
showAdminPanel();
} else {
showLogin();
}
}

// HARİTA VE KONUM İŞLEMLERİ
function initMap() {
const initialLat = 41.0082;
const initialLng = 28.9784;

if (document.getElementById('map')) {
if (map) {
map.remove();
}
map = L.map('map').setView([initialLat, initialLng], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Teslimat işaretleyicileri için özel ikon
window.deliveryIcon = L.icon({
iconUrl: 'https://cdn-icons-png.flaticon.com/512/1170/1170679.png',
iconSize: [32, 32],
iconAnchor: [16, 16],
popupAnchor: [0, -16]
});

fetchRiderLocations();
} else {
console.error("Harita için 'map' ID'sine sahip element bulunamadı!");
}
}

function updateRiderLocationOnMap(locationData) {
const { username, latitude, longitude, fullName } = locationData;
const latLng = [latitude, longitude];

if (!map) {
console.warn('Harita henüz başlatılmadı veya bulunamadı. Konum güncellenemiyor.');
return;
}

const customIcon = L.icon({
iconUrl: 'images/motorcu_icon.png',
iconSize: [32, 32],
iconAnchor: [16, 16],
popupAnchor: [0, -16]
});

if (riderMarkers[username]) {
riderMarkers[username].setLatLng(latLng);
if (riderMarkers[username].getPopup()) {
riderMarkers[username].getPopup().setContent(
`<div><strong>Motorcu Adı:</strong> ${fullName || username}</div>` +
`<div><strong>Kullanıcı Adı (Sistem):</strong> ${username}</div>` +
`<div><strong>Konum:</strong> ${latitude.toFixed(4)}, ${longitude.toFixed(4)}</div>` +
`<div><strong>Hız:</strong> ${locationData.speed ? (locationData.speed * 3.6).toFixed(2) + ' km/s' : 'Bilinmiyor'}</div>` +
`<div><strong>Yön:</strong> ${locationData.bearing !== undefined ? locationData.bearing.toFixed(0) + '°' : 'Bilinmiyor'}</div>` +
`<div><strong>Hassasiyet:</strong> ${locationData.accuracy !== undefined ? locationData.accuracy.toFixed(2) + ' m' : 'Bilinmiyor'}</div>` +
`<div><strong>Güncellenme:</strong> ${new Date(locationData.timestamp).toLocaleTimeString()}</div>`
);
}
} else {
riderMarkers[username] = L.marker(latLng, { icon: customIcon }).addTo(map)
.bindPopup(
`<div><strong>Motorcu Adı:</strong> ${fullName || username}</div>` +
`<div><strong>Kullanıcı Adı (Sistem):</strong> ${username}</div>` +
`<div><strong>Konum:</strong> ${latitude.toFixed(4)}, ${longitude.toFixed(4)}</div>` +
`<div><strong>Hız:</strong> ${locationData.speed ? (locationData.speed * 3.6).toFixed(2) + ' km/s' : 'Bilinmiyor'}</div>` +
`<div><strong>Yön:</strong> ${locationData.bearing !== undefined ? locationData.bearing.toFixed(0) + '°' : 'Bilinmiyor'}</div>` +
`<div><strong>Hassasiyet:</strong> ${locationData.accuracy !== undefined ? locationData.accuracy.toFixed(2) + ' m' : 'Bilinmiyor'}</div>` +
`<div><strong>Güncellenme:</strong> ${new Date(locationData.timestamp).toLocaleTimeString()}</div>`
);
}
updateActiveRiderCount();
}

function addDeliveryMarker(order) {
if (!order.deliveryAddress || !order.deliveryLocation) return;

if (deliveryMarkers[order.orderId]) {
deliveryMarkers[order.orderId].remove();
}

const latLng = [order.deliveryLocation.latitude, order.deliveryLocation.longitude];
deliveryMarkers[order.orderId] = L.marker(latLng, {
icon: window.deliveryIcon,
zIndexOffset: 1000
}).addTo(map)
.bindPopup(`
               <div><strong>Sipariş ID:</strong> ${order.orderId.substring(0, 8)}</div>
               <div><strong>Masa:</strong> ${order.masaAdi}</div>
               <div><strong>Adres:</strong> ${order.deliveryAddress}</div>
               ${order.customerPhone ? `<div><strong>Telefon:</strong> ${order.customerPhone}</div>` : ''}
           `);
}

function removeDeliveryMarker(orderId) {
if (deliveryMarkers[orderId]) {
deliveryMarkers[orderId].remove();
delete deliveryMarkers[orderId];
}
}

function updateActiveRiderCount() {
const count = Object.keys(riderMarkers).length;
activeRiderCountEl.textContent = `(${count} Aktif)`;
}

// SİPARİŞ ALIM DURUMU YÖNETİMİ
async function fetchOrderReceptionStatus() {
const authToken = getAuthToken();
if (!authToken) {
console.error("fetchOrderReceptionStatus: Yetkilendirme token'ı bulunamadı.");
return;
}
try {
const response = await fetch(`${API_BASE_URL}/api/order-status`, {
headers: { 'Authorization': `Bearer ${authToken}` }
});
if (!response.ok) {
throw new Error(`HTTP error! status: ${response.status}`);
}
const data = await response.json();
updateOrderReceptionButtonUI(data.enabled);
} catch (error) {
console.error('Sipariş durumu çekilirken hata oluştu:', error);
alert('Sipariş durumu alınamadı.');
}
}

async function toggleOrderReceptionStatus() {
const authToken = getAuthToken();
if (!authToken) {
console.error("toggleOrderReceptionStatus: Yetkilendirme token'ı bulunamadı.");
alert("İşlem başarısız: Lütfen tekrar giriş yapın.");
return;
}

const isCurrentlyEnabled = orderStatusToggleButton.classList.contains('enabled');
const newStatus = !isCurrentlyEnabled;

orderStatusToggleButton.textContent = 'Güncelleniyor...';
orderStatusToggleButton.disabled = true;

try {
const response = await fetch(`${API_BASE_URL}/api/set-order-status`, {
method: 'POST',
headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
body: JSON.stringify({ enabled: newStatus })
});
if (!response.ok) {
const errorData = await response.json().catch(() => ({}));
throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
}
const data = await response.json();
updateOrderReceptionButtonUI(data.newStatus);
alert(`Sipariş alımı durumu başarıyla güncellendi: ${data.newStatus ? 'AÇIK' : 'KAPALI'}`);
} catch (error) {
console.error('Sipariş durumu güncellenirken hata oluştu:', error);
alert(`Sipariş durumu güncellenemedi: ${error.message}`);
} finally {
orderStatusToggleButton.disabled = false;
}
}

function updateOrderReceptionButtonUI(isEnabled) {
if (isEnabled) {
orderStatusToggleButton.textContent = 'Sipariş Alımı: AÇIK';
orderStatusToggleButton.classList.remove('disabled');
orderStatusToggleButton.classList.add('enabled');
orderStatusToggleButton.style.backgroundColor = '#28a745';
} else {
orderStatusToggleButton.textContent = 'Sipariş Alımı: KAPALI';
orderStatusToggleButton.classList.remove('enabled');
orderStatusToggleButton.classList.add('disabled');
orderStatusToggleButton.style.backgroundColor = '#dc3545';
}
}

// SİPARİŞLERİ RENDER ETME
function renderOrders() {
const sortedOrders = Object.values(orders).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
ordersContainer.innerHTML = '';

if (sortedOrders.length === 0) {
ordersContainer.innerHTML = '<p>Aktif sipariş bulunamadı.</p>';
return;
}

sortedOrders.forEach(order => {
const orderCard = document.createElement('div');
orderCard.id = `order-${order.orderId}`;
orderCard.className = `card ${getStatusClass(order.deliveryStatus || order.status)}`;
orderCard.dataset.orderId = order.orderId;

let riderInfoHtml = '';
if (order.riderUsername && order.deliveryAddress && order.paymentMethod) {
riderInfoHtml = `
                       <div class="rider-info">
                           <p class="text-xs text-gray-600 mt-1">Atanan Motorcu: ${order.riderUsername}</p>
                           <p class="text-xs text-gray-600">Teslimat Adresi: ${order.deliveryAddress}</p>
                           ${order.customerPhone ? `<p class="text-xs text-gray-600">Telefon: ${order.customerPhone}</p>` : ''}
                           <p class="text-xs text-gray-600">Ödeme Yöntemi: ${order.paymentMethod}</p>
                       </div>
                   `;
}

const showAssignButton = (order.deliveryStatus === 'pending' && order.status !== 'paid');

orderCard.innerHTML = `
                   <h3 class="text-lg font-bold mb-2">Masa: ${order.masaAdi} (ID: ${order.masaId})</h3>
                   <p class="text-gray-700 text-sm mb-1">Sipariş ID: ${order.orderId.substring(0, 8)}...</p>
                   <p class="text-gray-700 text-sm mb-1">Zaman: ${new Date(order.timestamp).toLocaleString()}</p>
                   <div class="mt-3 mb-2">
                       <p class="font-semibold text-gray-800">Ürünler:</p>
                       ${order.sepetItems.map(item => `
                           <div class="order-item">
                               <span>${item.urunAdi} x ${item.adet}</span>
                               <span>${formatPrice(item.fiyat * item.adet)}</span>
                           </div>
                       `).join('')}
                   </div>
                   <p class="text-lg font-bold text-right mt-3">Toplam: ${formatPrice(order.toplamFiyat)}</p>
                   <p class="order-status-text text-sm font-semibold mt-2 ${getStatusClass(order.deliveryStatus || order.status)}">Durum: ${getOrderStatusText(order.status, order.deliveryStatus)}</p>
                   ${riderInfoHtml}

                   <div class="flex justify-end mt-4 space-x-2">
                       <button class="pay-button" onclick="markOrderAsPaid('${order.orderId}')" ${order.status === 'paid' ? 'disabled' : ''}>Ödendi Olarak İşaretle</button>
                       <button class="print-button" onclick="printOrderReceipt('${order.orderId}')">Yazdır</button>
                       ${showAssignButton ? `<button class="assign-rider-btn" onclick="openAssignOrderModal('${order.orderId}')">Motorcuya Gönder</button>` : ''}
                   </div>
               `;
ordersContainer.prepend(orderCard);
});
}

function formatPrice(price) {
return price.toFixed(2).replace('.', ',') + ' TL';
}

function getStatusClass(status) {
switch (status) {
case 'pending': return 'status-pending';
case 'paid': return 'status-paid';
case 'assigned': return 'status-assigned';
case 'en_route': return 'status-en_route';
case 'delivered': return 'status-delivered';
case 'cancelled': return 'status-cancelled';
default: return '';
}
}

function getOrderStatusText(status, deliveryStatus) {
if (deliveryStatus && deliveryStatus !== 'pending') {
switch (deliveryStatus) {
case 'assigned': return 'Motorcuya Atandı';
case 'en_route': return 'Yolda';
case 'delivered': return 'Teslim Edildi';
case 'cancelled': return 'İptal Edildi';
default: return deliveryStatus;
}
}
switch (status) {
case 'pending': return 'Beklemede';
case 'paid': return 'Ödendi';
case 'cancelled': return 'İptal Edildi';
default: return status;
}
}

function removeOrderFromDisplay(orderId) {
console.log(`removeOrderFromDisplay çağrıldı: ${orderId}`);
if (orders[orderId]) {
delete orders[orderId];
renderOrders();
} else {
console.warn(`Sipariş ${orderId} orders objesinde bulunamadı.`);
}
}

function markOrderAsPaid(orderId) {
console.log(`markOrderAsPaid çağrıldı: ${orderId}`);
socket.emit('orderPaid', { orderId: orderId });
}

function printOrderReceipt(orderId) {
const order = orders[orderId];
if (!order) {
alert('Yazdırılacak sipariş bulunamadı!');
return;
}
let printContent = `
               <div class="receipt-container">
                   <div class="receipt-header">--- Olimpiyat Kokoreç ---</div>
                   <p class="receipt-info">Masa: ${order.masaAdi}</p>
                   <p class="receipt-info">Sipariş ID: ${order.orderId.substring(0, 8)}...</p>
                   <p class="receipt-info">Zaman: ${new Date(order.timestamp).toLocaleString()}</p>
                   ${order.deliveryAddress ? `<p class="receipt-info">Adres: ${order.deliveryAddress}</p>` : ''}
                   ${order.customerPhone ? `<p class="receipt-info">Telefon: ${order.customerPhone}</p>` : ''}
                   ${order.paymentMethod ? `<p class="receipt-info">Ödeme: ${order.paymentMethod}</p>` : ''}
                   <hr>
                   <div class="receipt-items">
           `;

order.sepetItems.forEach(item => {
const itemName = item.urunAdi;
const itemQuantity = item.adet;
const itemPrice = item.fiyat;
printContent += `<p class="receipt-item">${itemName} (${itemQuantity} adet) - ${(itemPrice * itemQuantity).toFixed(2)} TL</p>`;
});

printContent += `
                   </div>
                   <hr>
                   <div class="receipt-total">TOPLAM: ${order.toplamFiyat.toFixed(2)} TL</div>
                   <div class="receipt-footer">Afiyet Olsun! Teşekkürler!</div>
               </div>
           `;

let printWindow = window.open('', '_blank');
printWindow.document.write('<!DOCTYPE html><html><head><title>Fiş - ' + order.masaAdi + '</title>');
printWindow.document.write('<style>');
printWindow.document.write(`
               @page {
                   size: 58mm auto;
                   margin: 0;
               }
               body {
                   width: 58mm;
                   margin: 0;
                   font-family: 'Consolas', 'Courier New', monospace;
                   font-size: 10px;
                   line-height: 1.2;
                   color: #000;
               }
               .receipt-container {
                   padding: 5mm;
                   box-sizing: border-box;
               }
               .receipt-header, .receipt-footer {
                   text-align: center;
                   margin-bottom: 5px;
                   font-size: 12px;
               }
               .receipt-info p, .receipt-item {
                   margin: 2px 0;
                   white-space: pre-wrap;
               }
               .receipt-total {
                   font-weight: bold;
                   text-align: right;
                   margin-top: 10px;
                   font-size: 11px;
               }
               hr {
                   border: 0;
                   border-top: 1px dashed #888;
                   margin: 5px 0;
               }
           `);
printWindow.document.write('</style>');
printWindow.document.write('</head><body>');
printWindow.document.write(printContent);
printWindow.document.write('</body></html>');
printWindow.document.close();
printWindow.focus();
printWindow.print();
}

// MOTORCUYA SİPARİŞ ATAMA MODALI FONKSİYONLARI
async function openAssignOrderModal(orderId) {
currentOrderToAssign = orders[orderId];
if (!currentOrderToAssign) {
alert('Sipariş bulunamadı!');
return;
}

modalOrderId.value = currentOrderToAssign.orderId.substring(0, 8);
modalMasaAdi.value = currentOrderToAssign.masaAdi;
deliveryAddressInput.value = '';
customerPhoneInput.value = '';
paymentMethodSelect.value = '';

await fetchAndPopulateRiders();

assignOrderModal.style.display = 'flex';
}

function closeAssignOrderModal() {
assignOrderModal.style.display = 'none';
currentOrderToAssign = null;
}

async function fetchAndPopulateRiders() {
selectRider.innerHTML = '<option value="">Yükleniyor...</option>';
try {
const response = await fetch(`${API_BASE_URL}/api/riders-locations`, {
headers: {
'Authorization': `Bearer ${getAuthToken()}`
}
});

if (!response.ok) {
const errorData = await response.json().catch(() => ({}));
throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
}

const riders = await response.json();

selectRider.innerHTML = '';
if (!Array.isArray(riders) || riders.length === 0) {
selectRider.innerHTML = '<option value="">Aktif Motorcu Yok</option>';
selectRider.disabled = true;
} else {
selectRider.disabled = false;
selectRider.innerHTML = '<option value="">Motorcu Seçiniz</option>';
riders.forEach(rider => {
const option = document.createElement('option');
option.value = rider.username;
option.textContent = rider.full_name || rider.username;
selectRider.appendChild(option);
});
}
} catch (error) {
console.error('Motorcular çekilirken hata:', error);
selectRider.innerHTML = '<option value="">Motorcular yüklenemedi</option>';
selectRider.disabled = true;
}
}

async function assignOrder() {
if (!currentOrderToAssign) return;

const deliveryAddress = deliveryAddressInput.value.trim();
const paymentMethod = paymentMethodSelect.value;
const selectedRider = selectRider.value;
const customerPhone = customerPhoneInput.value.trim();

if (!deliveryAddress || !paymentMethod || !selectedRider) {
alert('Lütfen zorunlu alanları doldurun ve bir motorcu seçin.');
return;
}

try {
// Adres koordinatlarını almak için geocoding API'si kullanımı
const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(deliveryAddress)}`);
const geocodeData = await geocodeResponse.json();

if (!geocodeData || geocodeData.length === 0) {
throw new Error('Adres bulunamadı');
}

const location = {
latitude: parseFloat(geocodeData[0].lat),
longitude: parseFloat(geocodeData[0].lon)
};

const authToken = getAuthToken();
const response = await fetch(`${API_BASE_URL}/api/assign-order`, {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${authToken}`
},
body: JSON.stringify({
orderId: currentOrderToAssign.orderId,
riderUsername: selectedRider,
deliveryAddress: deliveryAddress,
deliveryLocation: location,
paymentMethod: paymentMethod,
customerPhone: customerPhone || null
})
});

const data = await response.json();

if (response.ok) {
alert('Sipariş başarıyla motorcuya atandı!');
closeAssignOrderModal();
} else {
alert(`Sipariş atama hatası: ${data.message || response.statusText}`);
}
} catch (error) {
console.error('Sipariş atanırken hata:', error);
alert(`Sipariş atanamadı: ${error.message}`);
}
}

// API İSTEKLERİ
async function fetchCurrentActiveOrders() {
const authToken = getAuthToken();
if (!authToken) {
console.error("fetchCurrentActiveOrders: Yetkilendirme token'ı bulunamadı.");
ordersContainer.innerHTML = '<p>Siparişler yüklenemedi: Yetkilendirme hatası.</p>';
return;
}

try {
const response = await fetch(`${API_BASE_URL}/api/orders/active`, {
headers: { 'Authorization': `Bearer ${authToken}` }
});

if (!response.ok) {
const errorData = await response.json().catch(() => ({}));
throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
}

const fetchedOrders = await response.json();
Object.keys(orders).forEach(key => delete orders[key]);
fetchedOrders.forEach(order => {
orders[order.orderId] = order;
if (order.deliveryLocation) {
addDeliveryMarker(order);
}
});
renderOrders();
} catch (error) {
console.error('Aktif siparişler çekilirken hata:', error);
ordersContainer.innerHTML = `<p>Siparişler yüklenemedi: ${error.message}</p>`;
}
}

async function fetchRiderLocations() {
const authToken = getAuthToken();
if (!authToken) {
console.error("fetchRiderLocations: Yetkilendirme token'ı bulunamadı.");
activeRiderCountEl.textContent = 'Motorcu konumları yüklenemedi: Yetkilendirme hatası.';
return;
}

try {
const response = await fetch(`${API_BASE_URL}/api/riders-locations`, {
headers: { 'Authorization': `Bearer ${authToken}` }
});

if (!response.ok) {
const errorData = await response.json().catch(() => ({}));
throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
}

const locations = await response.json();
console.log("Motorcu konumları:", locations);

if (!Array.isArray(locations)) {
console.error("API'den beklenen motorcu konum listesi bir dizi değil:", locations);
alert("Motorcu konumları yüklenemedi: Sunucudan hatalı veri formatı alındı.");
activeRiderCountEl.textContent = 'Motorcu konumları yüklenemedi: Hatalı veri.';
return;
}

Object.values(riderMarkers).forEach(marker => marker.remove());
Object.keys(riderMarkers).forEach(key => delete riderMarkers[key]);

locations.forEach(locationData => {
updateRiderLocationOnMap(locationData);
});
updateActiveRiderCount();
} catch (error) {
console.error('Motorcu konumları çekilirken hata:', error);
activeRiderCountEl.textContent = `Motorcu konumları yüklenemedi: ${error.message}`;
}
}

function removeRiderFromDisplay(username) {
if (riderMarkers[username]) {
riderMarkers[username].remove();
delete riderMarkers[username];
updateActiveRiderCount();
}
}

// Olay Dinleyicileri ve Başlangıç Kodları
document.addEventListener('DOMContentLoaded', () => {
loginForm.addEventListener('submit', handleLogin);
logoutButton.addEventListener('click', performLogout);
orderStatusToggleButton.addEventListener('click', toggleOrderReceptionStatus);

closeModalButton.addEventListener('click', closeAssignOrderModal);
cancelAssignButton.addEventListener('click', closeAssignOrderModal);
sendAssignButton.addEventListener('click', assignOrder);

window.addEventListener('click', (event) => {
if (event.target == assignOrderModal) {
closeAssignOrderModal();
}
});

notificationBell.addEventListener('click', () => {
notificationBell.classList.remove('ringing');
});

checkLoginStatus();
});

window.addEventListener('resize', () => {
if (map) {
map.invalidateSize();
}
});

// Socket.IO Olay Dinleyicileri
socket.on('connect', () => {
console.log('Socket.IO Bağlandı:', socket.id);
const username = localStorage.getItem('username');
const role = getUserRole();
if (username && role) {
socket.emit('registerClient', { username, role });
console.log(`Socket.IO ile kayıt gönderildi: ${username} (${role})`);
}
if (getAuthToken()) {
fetchCurrentActiveOrders();
fetchRiderLocations();
fetchOrderReceptionStatus();
}
});

socket.on('connect_error', (error) => {
console.error('Socket.IO Bağlantı Hatası:', error);
});

socket.on('disconnect', (reason) => {
console.log('Socket.IO Bağlantısı Kesildi. Neden:', reason);
});

socket.on('reconnect', (attemptNumber) => {
console.log('Socket.IO Yeniden Bağlandı. Deneme:', attemptNumber);
const username = localStorage.getItem('username');
const role = getUserRole();
if (username && role) {
socket.emit('registerClient', { username, role });
console.log(`Socket.IO ile yeniden kayıt gönderildi: ${username} (${role})`);
}
if (getAuthToken()) {
fetchCurrentActiveOrders();
fetchRiderLocations();
fetchOrderReceptionStatus();
}
});

socket.on('newOrder', (order) => {
console.log('Yeni sipariş alındı:', JSON.stringify(order, null, 2));
if (order && order.orderId) {
orders[order.orderId] = order;
renderOrders();
notificationSound.play().catch(err => console.error('Bildirim sesi oynatılamadı:', err));
notificationBell.classList.add('ringing');
setTimeout(() => {
notificationBell.classList.remove('ringing');
}, 1500);
} else {
console.error('Geçersiz sipariş verisi:', order);
}
});

socket.on('orderPaidConfirmation', (data) => {
console.log('Sipariş ödendi onayı alındı:', JSON.stringify(data, null, 2));
if (orders[data.orderId]) {
orders[data.orderId].status = 'paid';
renderOrders();
} else {
console.warn(`Sipariş ${data.orderId} orders objesinde bulunamadı.`);
}
});

socket.on('removeOrderFromDisplay', (data) => {
console.log('Sipariş ekrandan kaldırılıyor:', JSON.stringify(data, null, 2));
removeOrderFromDisplay(data.orderId);
removeDeliveryMarker(data.orderId);
});

socket.on('orderTakingStatusChanged', (data) => {
console.log('Sipariş alım durumu değişti:', data.enabled);
updateOrderReceptionButtonUI(data.enabled);
});

socket.on('currentActiveOrders', (currentOrders) => {
console.log('Mevcut aktif siparişler alındı:', currentOrders.length);
Object.keys(orders).forEach(key => delete orders[key]);
Object.keys(deliveryMarkers).forEach(key => {
if (deliveryMarkers[key]) {
deliveryMarkers[key].remove();
}
delete deliveryMarkers[key];
});

currentOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
currentOrders.forEach(order => {
orders[order.orderId] = order;
if (order.deliveryLocation) {
addDeliveryMarker(order);
}
});
renderOrders();
});

socket.on('newRiderLocation', (rider) => {
console.log('Yeni motorcu konumu alındı:', rider.username, rider.latitude, rider.longitude);
updateRiderLocationOnMap(rider);
updateActiveRiderCount();
});

socket.on('currentRiderLocations', (currentRiders) => {
console.log('Mevcut motorcu konumları Socket.IO üzerinden alındı:', currentRiders.length);
const activeUsernames = new Set();
const bounds = new L.LatLngBounds();

if (Array.isArray(currentRiders)) {
currentRiders.forEach(rider => {
updateRiderLocationOnMap(rider);
activeUsernames.add(rider.username);
bounds.extend([rider.latitude, rider.longitude]);
});
} else if (typeof currentRiders === 'object' && currentRiders !== null) {
Object.values(currentRiders).forEach(rider => {
updateRiderLocationOnMap(rider);
activeUsernames.add(rider.username);
bounds.extend([rider.latitude, rider.longitude]);
});
} else {
console.warn('currentRiderLocations olayı geçersiz veri formatı aldı:', currentRiders);
}

for (const username in riderMarkers) {
if (!activeUsernames.has(username)) {
console.log(`Motorcu ${username} artık aktif değil. Haritadan kaldırılıyor.`);
removeRiderFromDisplay(username);
}
}

updateActiveRiderCount();

if (map && Object.keys(riderMarkers).length > 0) {
if (Object.keys(riderMarkers).length > 1) {
map.fitBounds(bounds.pad(0.1));
} else {
const singleMarker = Object.values(riderMarkers)[0];
map.setView(singleMarker.getLatLng(), 14);
}
}
});

socket.on('riderDisconnected', (username) => {
console.log(`riderDisconnected olayı alındı: ${username}`);
removeRiderFromDisplay(username);
});

socket.on('orderAssigned', (order) => {
console.log('Sipariş atandı (Socket.IO):', order.orderId, 'Motorcu:', order.riderUsername);
if (orders[order.orderId]) {
orders[order.orderId] = order;
renderOrders();
if (order.deliveryLocation) {
addDeliveryMarker(order);
}
}
});

socket.on('orderDeliveryStatusUpdated', (data) => {
console.log('Sipariş teslimat durumu güncellendi (Socket.IO):', data.orderId, 'Yeni Durum:', data.newDeliveryStatus);
if (orders[data.orderId]) {
orders[data.orderId].deliveryStatus = data.newDeliveryStatus;
renderOrders();
if (data.newDeliveryStatus === 'delivered') {
removeDeliveryMarker(data.orderId);
}
}
});

socket.on('riderDayEnded', (data) => {
console.log('Motorcu günü sonlandırdı (Socket.IO):', data.username, 'Teslim Edilen Paket:', data.deliveredCount);
removeRiderFromDisplay(data.username);
alert(`${data.username} adlı motorcu gününü sonlandırdı. Bugün ${data.deliveredCount} paket teslim etti.`);
});
</script>
</body>
</html>
